
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>炫舞卡密验证与下载</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            background: radial-gradient(circle at top, #f5f7ff 0%, #edf1ff 35%, #f7f9ff 70%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1f2937;
        }

        .pc-warning {
            display: none;
            max-width: min(680px, 94vw);
            background: rgba(254, 226, 226, 0.75);
            border: 1px solid rgba(248, 113, 113, 0.6);
            border-radius: 18px;
            padding: 42px 32px;
            text-align: center;
            color: #b91c1c;
            font-size: 20px;
            line-height: 1.7;
            box-shadow: 0 24px 60px rgba(248, 113, 113, 0.28);
        }

            .pc-warning.visible {
                display: block;
            }

        .hidden {
            display: none !important;
        }

        .container {
            width: min(720px, 94vw);
            background-color: rgba(255, 255, 255, 0.92);
            border-radius: 20px;
            box-shadow: 0 28px 80px rgba(79, 114, 205, 0.15);
            padding: 40px 48px;
            backdrop-filter: blur(8px);
        }

        h1 {
            margin: 0 0 12px;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            color: #1d4ed8;
        }

        p.subtitle {
            margin: 0 0 28px;
            text-align: center;
            color: #4b5563;
            line-height: 1.6;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        label {
            font-weight: 600;
            color: #374151;
        }

        input[type="text"] {
            padding: 14px 16px;
            border: 1px solid #c7d2fe;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }

            input[type="text"]:focus {
                outline: none;
                border-color: #6366f1;
                box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            }

        button[type="submit"] {
            padding: 14px 20px;
            font-size: 17px;
            font-weight: 600;
            color: #ffffff;
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

            button[type="submit"]:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            button[type="submit"]:not(:disabled):hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
            }

        .result {
            margin-top: 32px;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e5e7eb;
            background-color: rgba(248, 250, 252, 0.8);
        }

            .result.hidden {
                display: none;
            }

        .status-message {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

            .status-message.success {
                color: #047857;
            }

            .status-message.warning {
                color: #ca8a04;
            }

            .status-message.error {
                color: #dc2626;
            }

            .status-message.info {
                color: #2563eb;
            }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1 1 180px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }

        .download-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(59, 130, 246, 0.1));
            border-radius: 14px;
            padding: 20px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

            .download-card h2 {
                margin: 0 0 12px;
                font-size: 20px;
                color: #1d4ed8;
            }

        .copy-btn {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background-color: rgba(37, 99, 235, 0.12);
            color: #1d4ed8;
            transition: background-color 0.2s ease;
        }

            .copy-btn:hover {
                background-color: rgba(37, 99, 235, 0.22);
            }

        .helper-text {
            margin-top: 20px;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.6;
        }

        .download-history-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .download-entry {
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid #dbeafe;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 12px 32px rgba(79, 70, 229, 0.08);
        }

            .download-entry.new {
                border-color: rgba(34, 197, 94, 0.6);
                box-shadow: 0 16px 36px rgba(34, 197, 94, 0.15);
            }

        .download-entry-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .download-entry-title {
            font-weight: 600;
            color: #1d4ed8;
        }

        .download-entry-time {
            font-size: 13px;
            color: #6b7280;
        }

        .download-entry-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .download-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 6px;
        }

        .download-field {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

            .download-field a {
                color: #1d4ed8;
                word-break: break-all;
            }

        .download-badge {
            background: rgba(34, 197, 94, 0.18);
            color: #047857;
            border-radius: 999px;
            padding: 2px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .download-note {
            margin: 0 0 12px;
            color: #2563eb;
            font-size: 14px;
        }

        @media (max-width: 640px) {
            body {
                padding: 24px 12px;
                display: block;
                min-height: auto;
            }

            .container {
                width: 100%;
                padding: 26px 20px;
                border-radius: 18px;
            }

            h1 {
                font-size: 24px;
            }

            button[type="submit"] {
                font-size: 16px;
                padding: 12px 16px;
            }

            .pc-warning {
                padding: 28px 20px;
                font-size: 18px;
            }

            .stats {
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="pc-warning" class="pc-warning">请复制网址使用手机或平板浏览器打开，请勿使用电脑访问。</div>
    <main id="app-container" class="container">
        <h1>炫舞卡密验证与下载</h1>
        <p class="subtitle">验证您的卡密是否有效，并在验证通过后领取最新下载链接。</p>
        <form id="verify-form">
            <div>
                <label for="card-key">卡密</label>
                <input id="card-key" name="card-key" type="text" maxlength="64" placeholder="请输入卡密" autocomplete="off" required />
            </div>
            <button type="submit">验证并获取下载</button>
        </form>
        <section id="result" class="result hidden">
            <div id="status" class="status-message"></div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-label">验证次数</div>
                    <div id="attempt-count" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">卡密状态</div>
                    <div id="card-status" class="stat-value">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">到期时间</div>
                    <div id="expire-time" class="stat-value">-</div>
                </div>
            </div>
            <div id="download-card" class="download-card hidden">
                <h2>您的下载链接记录</h2>
                <p id="link-limit-note" class="download-note hidden"></p>
                <div id="download-history" class="download-history-list"></div>
            </div>
            <p class="helper-text">系统会在验证成功后自动分配下载链接，每个卡密最多可领取 3 条链接，记录会显示在此页面。</p>
        </section>
    </main>
    <script>
        const container = document.getElementById('app-container');
        const pcWarningEl = document.getElementById('pc-warning');
        const form = document.getElementById('verify-form');
        const cardKeyInput = document.getElementById('card-key');
        const resultSection = document.getElementById('result');
        const statusEl = document.getElementById('status');
        const attemptEl = document.getElementById('attempt-count');
        const cardStatusEl = document.getElementById('card-status');
        const expireTimeEl = document.getElementById('expire-time');
        const downloadCard = document.getElementById('download-card');
        const downloadHistoryEl = document.getElementById('download-history');
        const linkLimitNote = document.getElementById('link-limit-note');

        const STORAGE_PREFIX = 'card-verify-history:';
        const submitButton = form.querySelector('button[type="submit"]');
        let apiBase = '';
        const shareContext = resolveShareContext();
        if (shareContext && shareContext.gateway) {
            apiBase = shareContext.gateway;
        }

        clearLegacyCache();
        enforceMobileExperience();

        if (!shareContext) {
            showStatus('当前链接缺少软件信息，请联系代理重新生成。', 'error');
            disableForm();
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const cardKey = cardKeyInput.value.trim();
            if (!cardKey) {
                showStatus('请输入卡密后再试。', 'error');
                return;
            }

            if (!shareContext) {
                showStatus('当前链接缺少软件信息，请联系代理重新生成。', 'error');
                return;
            }

            setLoading(true);
            try {
                const endpoint = buildVerificationEndpoint(shareContext);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cardKey,
                        software: shareContext.software,
                        softwareCode: shareContext.softwareCode,
                        agentAccount: shareContext.agentAccount || undefined
                    })
                });

                const payload = await response.json();
                if (!response.ok || typeof payload !== 'object') {
                    throw new Error('网络请求失败');
                }

                if (payload.code !== 0) {
                    showResult({
                        message: payload.message || '卡密验证失败',
                        verificationPassed: false,
                        attemptNumber: payload.data?.attemptNumber ?? 0,
                        expiresAt: null,
                        download: null,
                        downloadHistory: [],
                        hasReachedLinkLimit: false
                    }, payload.message);
                    return;
                }

                showResult(payload.data, payload.message);
            } catch (error) {
                console.error(error);
                showStatus('请求失败，请稍后再试。', 'error');
            } finally {
                setLoading(false);
            }
        });

        document.addEventListener('click', async (event) => {
            const button = event.target.closest('button[data-copy-text]');
            if (!button) {
                return;
            }

            const text = button.getAttribute('data-copy-text') ?? '';
            const originalLabel = button.getAttribute('data-copy-label') || button.textContent || '复制';

            try {
                await navigator.clipboard.writeText(text);
                button.textContent = '已复制';
                setTimeout(() => {
                    button.textContent = originalLabel;
                }, 1800);
            } catch (err) {
                console.warn(err);
                alert('复制失败，请手动选择复制。');
            }
        });

        function disableForm() {
            if (cardKeyInput) {
                cardKeyInput.disabled = true;
            }
            if (submitButton) {
                submitButton.disabled = true;
            }
        }

        function resolveShareContext() {
            const query = extractCombinedQuery();
            if (!query) {
                return null;
            }

            const map = parseQuery(query);
            const shareSlug = decodeURIComponentSafe(map.share || '');
            if (shareSlug) {
                const decoded = decodeShareSlug(shareSlug);
                if (decoded) {
                    if (decoded.gateway) {
                        apiBase = decoded.gateway;
                    }
                    return decoded;
                }
            }

            const software = decodeURIComponentSafe(map.s || map.software || map.softwareName || map.slot || '');
            const code = decodeURIComponentSafe(map.c || map.code || map.softwarecode || map.softwareCode || map.binding || '');
            const agent = decodeURIComponentSafe(map.a || map.agent || map.agentAccount || '');
            const gateway = resolveGateway(decodeURIComponentSafe(map.gateway || map.api || map.gw || ''));

            if (software && code) {
                if (gateway) {
                    apiBase = gateway;
                }
                return {
                    software,
                    softwareCode: code,
                    agentAccount: agent || undefined,
                    gateway: gateway || undefined
                };
            }

            return null;
        }

        function extractCombinedQuery() {
            const segments = [];
            if (window.location.search) {
                segments.push(window.location.search.replace(/^\?/, ''));
            }
            if (window.location.hash) {
                const hash = window.location.hash;
                const idx = hash.indexOf('?');
                if (idx >= 0) {
                    segments.push(hash.substring(idx + 1));
                }
            }
            return segments.filter(Boolean).join('&');
        }

        function parseQuery(query) {
            const result = {};
            if (!query) {
                return result;
            }
            const pairs = query.split('&');
            for (const pair of pairs) {
                if (!pair) {
                    continue;
                }
                const [rawKey, rawValue = ''] = pair.split('=');
                const key = (rawKey || '').trim();
                if (!key) {
                    continue;
                }
                result[key] = rawValue;
            }
            return result;
        }

        function decodeShareSlug(slug) {
            if (!slug) {
                return null;
            }
            try {
                let base64 = slug.replace(/-/g, '+').replace(/_/g, '/');
                const padding = base64.length % 4;
                if (padding) {
                    base64 = base64.padEnd(base64.length + (4 - padding), '=');
                }
                const bytes = base64ToBytes(base64);
                const json = utf8Decode(bytes);
                const payload = JSON.parse(json) || {};
                const software = typeof payload.s === 'string'
                    ? payload.s.trim()
                    : (typeof payload.software === 'string' ? payload.software.trim() : '');
                const code = typeof payload.c === 'string'
                    ? payload.c.trim()
                    : (typeof payload.code === 'string'
                        ? payload.code.trim()
                        : (typeof payload.softwareCode === 'string' ? payload.softwareCode.trim() : ''));
                const agent = typeof payload.a === 'string'
                    ? payload.a.trim()
                    : (typeof payload.agent === 'string' ? payload.agent.trim() : '');
                const gateway = resolveGateway(typeof payload.g === 'string' ? payload.g.trim() : '');
                if (!software || !code) {
                    return null;
                }
                if (gateway) {
                    apiBase = gateway;
                }
                return {
                    software,
                    softwareCode: code,
                    agentAccount: agent || undefined,
                    gateway: gateway || undefined
                };
            } catch (error) {
                console.warn('Failed to decode share slug', error);
                return null;
            }
        }

        function resolveGateway(value) {
            if (!value) {
                return '';
            }
            const trimmed = value.trim();
            if (!trimmed) {
                return '';
            }
            const lower = trimmed.toLowerCase();
            if (!lower.startsWith('http://') && !lower.startsWith('https://')) {
                return '';
            }
            return trimmed.replace(/\/+$/, '');
        }

        function decodeURIComponentSafe(value) {
            if (!value) {
                return '';
            }
            try {
                return decodeURIComponent(value);
            } catch (error) {
                return value;
            }
        }

        function base64ToBytes(base64) {
            if (typeof atob === 'function') {
                const binary = atob(base64);
                const length = binary.length;
                const bytes = new Uint8Array(length);
                for (let i = 0; i < length; i += 1) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes;
            }
            throw new Error('当前环境不支持 Base64 解码');
        }

        function utf8Decode(bytes) {
            if (typeof TextDecoder !== 'undefined') {
                return new TextDecoder().decode(bytes);
            }
            let result = '';
            for (let i = 0; i < bytes.length;) {
                const byte1 = bytes[i++];
                if (byte1 < 0x80) {
                    result += String.fromCharCode(byte1);
                } else if (byte1 < 0xe0) {
                    const byte2 = bytes[i++];
                    result += String.fromCharCode(((byte1 & 0x1f) << 6) | (byte2 & 0x3f));
                } else if (byte1 < 0xf0) {
                    const byte2 = bytes[i++];
                    const byte3 = bytes[i++];
                    result += String.fromCharCode(((byte1 & 0x0f) << 12) | ((byte2 & 0x3f) << 6) | (byte3 & 0x3f));
                } else {
                    const byte2 = bytes[i++];
                    const byte3 = bytes[i++];
                    const byte4 = bytes[i++];
                    const codePoint = ((byte1 & 0x07) << 18) | ((byte2 & 0x3f) << 12) | ((byte3 & 0x3f) << 6) | (byte4 & 0x3f);
                    const offset = codePoint - 0x10000;
                    const high = 0xd800 + (offset >> 10);
                    const low = 0xdc00 + (offset & 0x3ff);
                    result += String.fromCharCode(high, low);
                }
            }
            return result;
        }

        function buildVerificationEndpoint(context) {
            if (!context || !(context.softwareCode || '').trim()) {
                throw new Error('缺少软件码');
            }
            const base = resolveGateway((context && context.gateway) || apiBase);
            if (base) {
                return `${base.replace(/\/+$/, '')}/api/card-verification/verify`;
            }
            return '/api/card-verification/verify';
        }

        function enforceMobileExperience() {
            const isMobileOrTablet = (() => {
                if (navigator.userAgentData && typeof navigator.userAgentData.mobile === 'boolean') {
                    return navigator.userAgentData.mobile;
                }

                const ua = (navigator.userAgent || navigator.vendor || window.opera || '').toLowerCase();
                if (/android|iphone|ipad|ipod|windows phone|iemobile|mobile|tablet|phone|touch|harmony|hmos|huawei|honor/.test(ua)) {
                    return true;
                }

                return /macintosh/.test(ua) && 'ontouchend' in document;
            })();

            if (!isMobileOrTablet) {
                if (container) {
                    container.style.display = 'none';
                }
                if (pcWarningEl) {
                    pcWarningEl.classList.add('visible');
                }
            } else {
                if (container) {
                    container.style.display = '';
                }
                if (pcWarningEl) {
                    pcWarningEl.classList.remove('visible');
                }
            }
        }

        function showResult(data, apiMessage) {
            if (!data) {
                showStatus('未获取到数据', 'error');
                clearDownloadHistory();
                return;
            }

            const history = Array.isArray(data.downloadHistory) ? data.downloadHistory : [];
            const message = apiMessage || data.message || (data.verificationPassed ? '卡密验证成功' : '卡密验证失败');
            const statusType = !data.verificationPassed ? 'error' : (history.length > 0 ? 'success' : 'warning');

            showStatus(message, statusType);

            attemptEl.textContent = data.attemptNumber ?? 0;
            cardStatusEl.textContent = data.verificationPassed ? '已启用' : '未通过';
            expireTimeEl.textContent = formatExpireTime(data.expiresAt);

            renderDownloadHistory(history, Boolean(data.hasReachedLinkLimit));

            resultSection.classList.remove('hidden');
        }

        function showStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = 'status-message ' + type;
            resultSection.classList.remove('hidden');
        }

        function renderDownloadHistory(history, hasReachedLimit) {
            downloadHistoryEl.innerHTML = '';

            if (!Array.isArray(history) || history.length === 0) {
                clearDownloadHistory();
                return;
            }

            history.forEach((item, index) => {
                const entry = document.createElement('div');
                entry.className = 'download-entry';
                if (item.isNew) {
                    entry.classList.add('new');
                }

                const header = document.createElement('div');
                header.className = 'download-entry-header';

                const title = document.createElement('span');
                title.className = 'download-entry-title';
                title.textContent = `下载链接 ${index + 1}`;
                header.appendChild(title);

                const time = document.createElement('span');
                time.className = 'download-entry-time';
                time.textContent = `分配时间：${formatAssignedMoment(item.assignedAt)}`;
                header.appendChild(time);

                if (item.isNew) {
                    const badge = document.createElement('span');
                    badge.className = 'download-badge';
                    badge.textContent = '最新';
                    header.appendChild(badge);
                }

                const body = document.createElement('div');
                body.className = 'download-entry-body';

                const linkField = document.createElement('div');
                linkField.className = 'download-field';
                const linkLabel = document.createElement('strong');
                linkLabel.textContent = '链接：';
                linkField.appendChild(linkLabel);

                const link = document.createElement('a');
                if (item.url) {
                    link.href = item.url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.textContent = item.url;
                } else {
                    link.href = '#';
                    link.textContent = '-';
                }
                linkField.appendChild(link);

                body.appendChild(linkField);

                const codeField = document.createElement('div');
                codeField.className = 'download-field';
                const codeLabel = document.createElement('strong');
                codeLabel.textContent = '提取码：';
                codeField.appendChild(codeLabel);

                const codeSpan = document.createElement('span');
                codeSpan.textContent = item.extractionCode || '-';
                codeField.appendChild(codeSpan);

                body.appendChild(codeField);

                const copyParts = [];
                if (item.url) {
                    copyParts.push(`链接：${item.url}`);
                }
                if (item.extractionCode) {
                    copyParts.push(`提取码：${item.extractionCode}`);
                }

                if (copyParts.length > 0) {
                    const actions = document.createElement('div');
                    actions.className = 'download-actions';

                    const combinedBtn = document.createElement('button');
                    const buttonLabel = copyParts.length > 1 ? '复制链接与提取码' : (item.url ? '复制链接' : '复制提取码');
                    combinedBtn.type = 'button';
                    combinedBtn.className = 'copy-btn';
                    combinedBtn.dataset.copyText = copyParts.join('\n');
                    combinedBtn.dataset.copyLabel = buttonLabel;
                    combinedBtn.textContent = buttonLabel;

                    actions.appendChild(combinedBtn);
                    body.appendChild(actions);
                }

                entry.appendChild(header);
                entry.appendChild(body);
                downloadHistoryEl.appendChild(entry);
            });

            if (hasReachedLimit) {
                linkLimitNote.textContent = '您已达到每个卡密最多 3 条下载链接的上限，请妥善保存以下所有链接。';
                linkLimitNote.classList.remove('hidden');
            } else {
                linkLimitNote.textContent = '提示：以下链接已记录在此页面，若未获取到新的链接请稍后再试。';
                linkLimitNote.classList.remove('hidden');
            }

            downloadCard.classList.remove('hidden');
        }

        function clearDownloadHistory() {
            downloadHistoryEl.innerHTML = '';
            downloadCard.classList.add('hidden');
            linkLimitNote.classList.add('hidden');
        }

        function formatExpireTime(timestamp) {
            if (timestamp === null || timestamp === undefined) {
                return '不限期';
            }

            const raw = String(timestamp).trim();
            if (!raw || raw === '0') {
                return '新卡';
            }

            let date;

            if (/^\d{14}$/.test(raw)) {
                const year = Number(raw.slice(0, 4));
                const month = Number(raw.slice(4, 6)) - 1;
                const day = Number(raw.slice(6, 8));
                const hour = Number(raw.slice(8, 10));
                const minute = Number(raw.slice(10, 12));
                const second = Number(raw.slice(12, 14));
                date = new Date(year, month, day, hour, minute, second);
            } else if (/^\d{13}$/.test(raw)) {
                date = new Date(Number(raw));
            } else if (/^\d{10}$/.test(raw)) {
                date = new Date(Number(raw) * 1000);
            } else {
                const numeric = Number(raw);
                if (Number.isFinite(numeric) && numeric > 0) {
                    date = new Date(numeric);
                }
            }

            if (Number.isNaN(date?.getTime())) {
                return raw;
            }

            return date.toLocaleString();
        }

        function formatAssignedMoment(timestamp) {
            if (timestamp === null || timestamp === undefined) {
                return '未知时间';
            }

            const raw = String(timestamp).trim();
            if (!raw) {
                return '未知时间';
            }

            let date;

            if (/^\d{14}$/.test(raw)) {
                const year = Number(raw.slice(0, 4));
                const month = Number(raw.slice(4, 6)) - 1;
                const day = Number(raw.slice(6, 8));
                const hour = Number(raw.slice(8, 10));
                const minute = Number(raw.slice(10, 12));
                const second = Number(raw.slice(12, 14));
                date = new Date(year, month, day, hour, minute, second);
            } else if (/^\d{13}$/.test(raw)) {
                date = new Date(Number(raw));
            } else if (/^\d{10}$/.test(raw)) {
                date = new Date(Number(raw) * 1000);
            }

            if (!date || Number.isNaN(date.getTime())) {
                return raw;
            }

            return date.toLocaleString();
        }

        function setLoading(isLoading) {
            if (!submitButton) {
                return;
            }
            if (isLoading) {
                submitButton.disabled = true;
                submitButton.textContent = '验证中…';
            } else {
                submitButton.disabled = false;
                submitButton.textContent = '验证并获取下载';
            }
        }

        function clearLegacyCache() {
            if (!window.localStorage) {
                return;
            }

            try {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i += 1) {
                    const key = localStorage.key(i);
                    if (!key) {
                        continue;
                    }

                    if (key === `${STORAGE_PREFIX}last-key` || key.startsWith(STORAGE_PREFIX)) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach((key) => localStorage.removeItem(key));
            } catch (error) {
                console.warn('清除旧缓存失败', error);
            }
        }
    </script>
</body>
</html>

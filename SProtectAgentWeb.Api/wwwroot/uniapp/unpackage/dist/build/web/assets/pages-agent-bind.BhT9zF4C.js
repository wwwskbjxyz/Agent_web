import{d as a,u as s,D as e,g as t,h as l,r as n,z as o,m as d,o as i,c,w as u,a as r,b as f,t as g,k as h,l as m,B as b,F as _,E as p,s as w,i as A,e as C,I as y,f as P,A as k,p as v,_ as V}from"./index-fvgcSFN3.js";const x=V(a({__name:"bind",setup(a){const V=s(),x=e(),B=t({softwareCode:"",authorAccount:"",authorPassword:""}),I=l((()=>V.loading.createBinding)),U=l((()=>V.bindings)),D=l((()=>V.loading.updateBinding)),j=n(!1),z=t({bindingId:0,authorAccount:"",authorPassword:""});async function E(a,s){if(a.authorAccount&&a.authorPassword)try{await x.login({username:a.authorAccount,password:a.authorPassword},{skipBootstrap:!1})}catch(e){if(!(null==s?void 0:s.silent)){const a=(null==e?void 0:e.message)&&"string"==typeof e.message?e.message:"自动登录作者端失败，请稍后重试";w({title:a,icon:"none"})}throw e}}async function F(){if(B.softwareCode&&B.authorAccount&&B.authorPassword)try{const s=await V.createBinding({...B});w({title:"绑定成功",icon:"success"}),V.selectBinding(s);try{await E(s,{silent:!0})}catch(a){console.warn("登录作者端失败",a)}B.softwareCode="",B.authorAccount="",B.authorPassword=""}catch(a){const s=(null==a?void 0:a.message)&&"string"==typeof a.message?a.message:"绑定失败，请检查软件码";w({title:s,icon:"none"})}else w({title:"请完整填写信息",icon:"none"})}function N(){j.value=!1}async function S(){if(!z.authorAccount||!z.authorPassword)return void w({title:"请输入完整信息",icon:"none"});const a=U.value.find((a=>a.bindingId===z.bindingId));if(a)try{await V.updateBinding(z.bindingId,{softwareCode:a.softwareCode,authorAccount:z.authorAccount.trim(),authorPassword:z.authorPassword}),w({title:"已更新",icon:"success"}),N()}catch(s){const a=(null==s?void 0:s.message)&&"string"==typeof s.message?s.message:"更新失败，请稍后重试";w({title:a,icon:"none"})}else w({title:"未找到绑定记录",icon:"none"})}return o((async()=>{V.isAuthenticated?V.bindings.length||await V.fetchAgentProfile():d({url:"/pages/login/agent"})})),(a,s)=>{const e=A,t=C,l=y,n=P;return i(),c(t,{class:"page"},{default:u((()=>[r(t,{class:"glass-card card"},{default:u((()=>[r(t,{class:"header"},{default:u((()=>[r(e,{class:"badge"},{default:u((()=>[f("绑定软件码")])),_:1}),r(e,{class:"title"},{default:u((()=>[f("为当前代理添加作者账号")])),_:1}),r(e,{class:"subtitle"},{default:u((()=>[f("输入作者提供的软件码与登录凭证，主控系统将代为安全转发。")])),_:1})])),_:1}),r(t,{class:"form"},{default:u((()=>[r(t,{class:"form-item"},{default:u((()=>[r(e,{class:"label"},{default:u((()=>[f("软件码")])),_:1}),r(l,{modelValue:B.softwareCode,"onUpdate:modelValue":s[0]||(s[0]=a=>B.softwareCode=a),class:"input",placeholder:"SP-xxxx"},null,8,["modelValue"])])),_:1}),r(t,{class:"form-item"},{default:u((()=>[r(e,{class:"label"},{default:u((()=>[f("作者账号")])),_:1}),r(l,{modelValue:B.authorAccount,"onUpdate:modelValue":s[1]||(s[1]=a=>B.authorAccount=a),class:"input",placeholder:"作者端登录账号"},null,8,["modelValue"])])),_:1}),r(t,{class:"form-item"},{default:u((()=>[r(e,{class:"label"},{default:u((()=>[f("作者密码")])),_:1}),r(l,{modelValue:B.authorPassword,"onUpdate:modelValue":s[2]||(s[2]=a=>B.authorPassword=a),class:"input",placeholder:"作者端登录密码",password:""},null,8,["modelValue"])])),_:1})])),_:1}),r(n,{class:"submit",disabled:I.value,onClick:F},{default:u((()=>[f(g(I.value?"绑定中...":"立即绑定"),1)])),_:1},8,["disabled"]),r(t,{class:"list"},{default:u((()=>[U.value.length?h("",!0):(i(),c(t,{key:0,class:"empty"},{default:u((()=>[f("暂未绑定任何作者，添加后可快速访问对应模块。")])),_:1})),(i(!0),m(_,null,b(U.value,(a=>(i(),c(t,{key:a.bindingId,class:"binding"},{default:u((()=>[r(t,{class:"binding-info"},{default:u((()=>[r(e,{class:"binding-title"},{default:u((()=>[f(g(a.authorDisplayName),1)])),_:2},1024),r(e,{class:"binding-sub"},{default:u((()=>[f("软件码："+g(a.softwareCode),1)])),_:2},1024),r(e,{class:"binding-sub"},{default:u((()=>[f("接口："+g(a.apiAddress)+":"+g(a.apiPort),1)])),_:2},1024)])),_:2},1024),r(t,{class:"binding-actions"},{default:u((()=>[r(n,{class:"binding-btn",onClick:s=>function(a){z.bindingId=a.bindingId,z.authorAccount=a.authorAccount,z.authorPassword=a.authorPassword,j.value=!0}(a)},{default:u((()=>[f("编辑凭证")])),_:2},1032,["onClick"]),r(n,{class:"binding-btn",onClick:s=>function(a){V.selectBinding(a),E(a,{silent:!0}).then((()=>{w({title:"已切换到 "+a.softwareCode,icon:"success"}),d({url:"/pages/index/index"})})).catch((()=>{d({url:"/pages/index/index"})}))}(a)},{default:u((()=>[f("进入")])),_:2},1032,["onClick"]),r(n,{class:"binding-btn danger",disabled:k(V).loading.deleteBinding,onClick:s=>async function(a){v({title:"确认删除",content:"删除后将无法通过主控访问该作者接口，确定删除吗？",success:async s=>{s.confirm&&(await V.deleteBinding(a),w({title:"已删除",icon:"success"}))}})}(a.bindingId)},{default:u((()=>[f(" 删除 ")])),_:2},1032,["disabled","onClick"])])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1}),j.value?(i(),c(t,{key:0,class:"editor-mask",onClick:p(N,["self"])},{default:u((()=>[r(t,{class:"glass-card editor-card"},{default:u((()=>[r(t,{class:"editor-header"},{default:u((()=>[r(e,{class:"editor-title"},{default:u((()=>[f("修改作者凭证")])),_:1}),r(e,{class:"editor-sub"},{default:u((()=>[f("更新后将用于转发登录")])),_:1})])),_:1}),r(t,{class:"form"},{default:u((()=>[r(t,{class:"form-item"},{default:u((()=>[r(e,{class:"label"},{default:u((()=>[f("作者账号")])),_:1}),r(l,{modelValue:z.authorAccount,"onUpdate:modelValue":s[3]||(s[3]=a=>z.authorAccount=a),class:"input",placeholder:"作者端登录账号"},null,8,["modelValue"])])),_:1}),r(t,{class:"form-item"},{default:u((()=>[r(e,{class:"label"},{default:u((()=>[f("作者密码")])),_:1}),r(l,{modelValue:z.authorPassword,"onUpdate:modelValue":s[4]||(s[4]=a=>z.authorPassword=a),class:"input",placeholder:"作者端登录密码",password:""},null,8,["modelValue"])])),_:1})])),_:1}),r(t,{class:"editor-actions"},{default:u((()=>[r(n,{class:"binding-btn ghost",onClick:N},{default:u((()=>[f("取消")])),_:1}),r(n,{class:"binding-btn",disabled:D.value,onClick:S},{default:u((()=>[f(g(D.value?"保存中...":"保存修改"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):h("",!0)])),_:1})}}}),[["__scopeId","data-v-816edf57"]]);export{x as default};

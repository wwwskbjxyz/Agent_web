import{d as e,D as a,x as l,g as t,r as s,h as n,y as r,z as c,o as i,c as o,w as u,a as d,b as m,t as f,E as p,l as y,B as g,F as b,A as k,k as v,s as w,C as _,i as h,e as C,f as T,I as x,v as V,U as A,W as S,V as j,p as $,X as P,Y as F,_ as U}from"./index-DVWvtVDx.js";import{D}from"./DataTable.4Z0V1oKr.js";import{S as M}from"./StatusTag.Dj0guwL1.js";import{S as O}from"./SoftwarePicker.CoML_QnP.js";const R=U(e({__name:"index",setup(e){const U=a(),{agents:R,selectedSoftware:I,agentTotal:L,cardTypes:z}=l(U),B=U.agentFilters,N=t({keyword:""}),E=[{label:"全部",value:"all"},{label:"启用",value:"enabled"},{label:"禁用",value:"disabled"}],W=s(0),X=[20,50,100],Y=s(1),q=n((()=>U.loading.agents)),G=n((()=>E.map((e=>e.label)))),H=n((()=>X.map((e=>`${e} 条/页`)))),J=t({username:"",type:""}),K=s(!1),Q=s(!1),Z=t({username:"",password:"",balance:"",timeStock:"",parities:"100",remark:"",cardTypes:[]}),ee=n((()=>z.value.map((e=>({name:e.name,label:oe(e)}))))),ae=n((()=>{var e;const a=(null==(e=E[W.value])?void 0:e.value)??"all";return R.value.filter((e=>"all"===a||e.status===a)).map((e=>({username:e.username,status:e.status,balance:e.balance.toFixed(2),timeStock:e.timeStock,parities:e.parities,totalParities:e.totalParities,remark:e.remark??"",cardTypes:e.cardTypes??[],cardTypesDisplay:e.cardTypes&&e.cardTypes.length?e.cardTypes.join("、"):"默认全部"})))})),le=n((()=>{const e=L.value||0,a=ae.value.length;return a===e?`共 ${e} 条记录`:`共 ${e} 条记录 · 当前筛选 ${a} 条`})),te=[{key:"username",label:"代理账号",style:"min-width:200rpx"},{key:"status",label:"状态",style:"min-width:160rpx"},{key:"balance",label:"余额(元)",style:"min-width:160rpx"},{key:"timeStock",label:"时间库存(小时)",style:"min-width:220rpx"},{key:"parities",label:"剩余授权",style:"min-width:180rpx"},{key:"totalParities",label:"累计授权",style:"min-width:200rpx"},{key:"cardTypesDisplay",label:"可售卡种",style:"min-width:240rpx"},{key:"remark",label:"备注信息",style:"min-width:240rpx"},{key:"operations",label:"操作",style:"min-width:360rpx"}],se=n((()=>B.page??1)),ne=n((()=>B.limit??X[Y.value]??50)),re=n((()=>{const e=ne.value||1;return Math.max(1,Math.ceil((L.value||0)/e))})),ce={enabled:"启用",disabled:"禁用"},ie={enabled:"success",disabled:"warning"};function oe(e){const a=j(e.duration);return a?`${e.name}（${a}）`:e.name}function ue(){Z.username="",Z.password="",Z.balance="0",Z.timeStock="0",Z.parities="100",Z.remark="",Z.cardTypes=[]}function de(){K.value||(Q.value=!1,ue())}function me(e){const a=Array.isArray(e.detail.value)?e.detail.value:[];Z.cardTypes=Array.from(new Set(a))}function fe(e,a){return J.username===e&&J.type===a}function pe(e,a){J.username=e,J.type=a}function ye(){J.username="",J.type=""}async function ge(e){const{title:a,placeholder:l="",defaultValue:t="",optional:s=!1}=e,n=await new Promise((e=>{$({title:a,content:t,editable:!0,placeholderText:l,confirmText:"确定",cancelText:s?"跳过":"取消",success:e,fail:()=>e({confirm:!1,cancel:!0})})}));return n.confirm?(n.content??"").trim():s?"":null}function be(){N.keyword=B.keyword??"";const e=X.findIndex((e=>e===(B.limit??50)));Y.value=e>=0?e:1}async function ke(){try{await U.loadAgents({keyword:N.keyword.trim(),page:1,limit:X[Y.value]??B.limit}),w({title:"查询完成",icon:"success"})}catch(e){console.error("searchAgents error",e),w({title:"查询失败",icon:"none"})}}async function ve(){N.keyword="",W.value=0,Y.value=X.indexOf(50)>=0?X.indexOf(50):0,await ke()}async function we(){try{await U.loadAgents({page:B.page,limit:B.limit,keyword:B.keyword}),w({title:"已刷新",icon:"none"})}catch(e){console.error("refreshList error",e)}}async function _e(e){if(!(e<1||e>re.value))try{await U.loadAgents({page:e})}catch(a){console.error("changePage error",a)}}async function he(e){const a=Number(e.detail.value);Y.value=a;const l=X[a]??50;try{await U.loadAgents({limit:l,page:1,keyword:N.keyword.trim()})}catch(t){console.error("onPageSizeChange error",t)}}function Ce(e){W.value=Number(e.detail.value)}function Te(e){return new Promise((a=>{$({title:"确认操作",content:e,confirmText:"确定",cancelText:"取消",success:e=>a(!!e.confirm),fail:()=>a(!1)})}))}function xe(e){const a=(e??"").toString().trim();a?_({data:a,success:()=>w({title:"已复制",icon:"success",duration:800})}):w({title:"无可复制内容",icon:"none"})}async function Ve(e,a){const l=a?"启用":"禁用";if(await Te(`确认${l}代理：${e.username}？`)){pe(e.username,a?"enable":"disable");try{const t=await U.toggleAgentStatus({usernames:[e.username],enable:a});w({title:t||`${l}成功`,icon:"success"})}catch(t){console.error("toggleStatus error",t),w({title:`${l}失败`,icon:"none"})}finally{ye()}}}async function Ae(){if(await U.ensureReady(),I.value){try{z.value.length||await U.loadCardTypes()}catch(e){console.error("loadCardTypes error",e)}ue(),Q.value=!0}else w({title:"请先选择软件位",icon:"none"})}async function Se(){if(K.value)return;const e=Z.username.trim();if(!e)return void w({title:"账号不能为空",icon:"none"});const a=Z.password.trim();if(!a)return void w({title:"密码不能为空",icon:"none"});const l=parseFloat(Z.balance||"0")||0,t=parseFloat(Z.timeStock||"0")||0,s=Math.max(0,parseFloat(Z.parities||"100")||100),n=Z.remark.trim(),r=Z.cardTypes.slice();K.value=!0;try{const c=await U.createAgent({username:e,password:a,balance:l,timeStock:t,parities:s,totalParities:s,remarks:n,cardTypes:r});w({title:c||"创建成功",icon:"success"}),Q.value=!1,ue()}catch(c){console.error("submitCreateAgent error",c),w({title:"创建失败",icon:"none"})}finally{K.value=!1}}return r((()=>[B.keyword,B.limit]),(()=>{be()}),{immediate:!0}),r((()=>ee.value),(e=>{const a=new Set(e.map((e=>e.name)));Z.cardTypes=Z.cardTypes.filter((e=>a.has(e)))}),{immediate:!0}),c((async()=>{await U.ensureReady();try{await U.loadAgents()}catch(e){console.error("agents/onMounted error",e)}be()})),r((()=>I.value),(async(e,a)=>{if(e&&e!==a){N.keyword="",W.value=0,Y.value=X.indexOf(50)>=0?X.indexOf(50):0;try{await U.loadAgents({page:1,keyword:"",limit:X[Y.value]})}catch(l){console.error("selectedSoftware change error",l)}be()}})),(e,a)=>{const l=h,t=C,s=T,n=x,r=V,c=A,_=P,j=F,$=S;return i(),o(t,{class:"page"},{default:u((()=>[d(t,{class:"header glass-card"},{default:u((()=>[d(t,{class:"header-main"},{default:u((()=>[d(l,{class:"title"},{default:u((()=>[m("代理管理")])),_:1}),d(l,{class:"subtitle"},{default:u((()=>[m("掌握渠道余额、库存及启用状态")])),_:1})])),_:1}),d(t,{class:"header-actions"},{default:u((()=>[d(O),d(s,{class:"btn ghost",disabled:q.value,onClick:we},{default:u((()=>[m("刷新")])),_:1},8,["disabled"]),d(s,{class:"btn primary",disabled:K.value,onClick:Ae},{default:u((()=>[m(f(K.value?"创建中...":"添加代理"),1)])),_:1},8,["disabled"])])),_:1})])),_:1}),d(t,{class:"filters glass-card"},{default:u((()=>[d(t,{class:"filters-grid"},{default:u((()=>[d(t,{class:"field keyword-field"},{default:u((()=>[d(l,{class:"label"},{default:u((()=>[m("搜索关键字")])),_:1}),d(n,{class:"input",modelValue:N.keyword,"onUpdate:modelValue":a[0]||(a[0]=e=>N.keyword=e),placeholder:"用户名 / 备注关键字","confirm-type":"search",onConfirm:ke},null,8,["modelValue"])])),_:1}),d(t,{class:"field"},{default:u((()=>[d(l,{class:"label"},{default:u((()=>[m("状态筛选")])),_:1}),d(r,{mode:"selector",range:G.value,value:W.value,onChange:Ce},{default:u((()=>[d(t,{class:"picker-display"},{default:u((()=>[m(f(G.value[W.value]),1)])),_:1})])),_:1},8,["range","value"])])),_:1}),d(t,{class:"field"},{default:u((()=>[d(l,{class:"label"},{default:u((()=>[m("每页条数")])),_:1}),d(r,{mode:"selector",range:H.value,value:Y.value,onChange:he},{default:u((()=>[d(t,{class:"picker-display"},{default:u((()=>[m(f(H.value[Y.value]),1)])),_:1})])),_:1},8,["range","value"])])),_:1})])),_:1}),d(t,{class:"filter-actions"},{default:u((()=>[d(s,{class:"btn primary",disabled:q.value,onClick:ke},{default:u((()=>[m(f(q.value?"查询中...":"搜索"),1)])),_:1},8,["disabled"]),d(s,{class:"btn ghost",disabled:q.value,onClick:ve},{default:u((()=>[m("重置")])),_:1},8,["disabled"])])),_:1})])),_:1}),d(D,{title:"子代理列表",subtitle:le.value,columns:te,rows:ae.value,loading:q.value,layout:"stack","primary-column":"username","operations-column":"operations"},{username:u((({row:e})=>[d(t,{class:"agent-header"},{default:u((()=>[d(l,{class:"agent-name copyable",onLongpress:a=>xe(e.username),onClick:p((a=>xe(e.username)),["stop"])},{default:u((()=>[m(f(e.username),1)])),_:2},1032,["onLongpress","onClick"]),d(M,{status:ie[e.status],label:ce[e.status]},null,8,["status","label"])])),_:2},1024)])),status:u((({row:e})=>[d(M,{status:ie[e.status],label:ce[e.status]},null,8,["status","label"])])),cardTypesDisplay:u((({row:e})=>[e.cardTypes.length?(i(),o(t,{key:0,class:"tag-list"},{default:u((()=>[(i(!0),y(b,null,g(e.cardTypes,(e=>(i(),o(t,{key:e,class:"tag"},{default:u((()=>[m(f(e),1)])),_:2},1024)))),128))])),_:2},1024)):(i(),o(l,{key:1,class:"placeholder"},{default:u((()=>[m("默认全部")])),_:1}))])),remark:u((({row:e})=>[e.remark?(i(),o(l,{key:0,class:"remark"},{default:u((()=>[m(f(e.remark),1)])),_:2},1024)):(i(),o(l,{key:1,class:"placeholder"},{default:u((()=>[m("—")])),_:1}))])),operations:u((({row:e})=>[d(t,{class:"action-group"},{default:u((()=>[d(s,{class:"action-btn",disabled:q.value||fe(e.username,"enable"),onClick:a=>Ve(e,!0)},{default:u((()=>[m(f(fe(e.username,"enable")?"处理中...":"启用"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn warn",disabled:q.value||fe(e.username,"disable"),onClick:a=>Ve(e,!1)},{default:u((()=>[m(f(fe(e.username,"disable")?"处理中...":"禁用"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn",disabled:q.value||fe(e.username,"adjust"),onClick:a=>async function(e){const a=await ge({title:"加款金额 (元)",placeholder:"可填写正负数",defaultValue:"0"});if(null===a)return;const l=await ge({title:"加时长 (小时)",placeholder:"可填写正负数",defaultValue:"0"});if(null===l)return;const t=parseFloat(a)||0,s=parseFloat(l)||0;if(t||s){pe(e.username,"adjust");try{const a=await U.adjustAgentBalance({username:e.username,balance:t,timeStock:s});w({title:a||"调整成功",icon:"success"})}catch(n){console.error("openAdjust error",n),w({title:"调整失败",icon:"none"})}finally{ye()}}else w({title:"请至少输入一项调整数值",icon:"none"})}(e)},{default:u((()=>[m(f(fe(e.username,"adjust")?"处理中...":"加款/加时"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn",disabled:q.value||fe(e.username,"remark"),onClick:a=>async function(e){const a=await ge({title:"修改备注",placeholder:"请输入备注内容",defaultValue:e.remark,optional:!0});if(null!==a){pe(e.username,"remark");try{const l=await U.updateAgentRemark({username:e.username,remark:a});w({title:l||"备注已更新",icon:"success"})}catch(l){console.error("openRemark error",l),w({title:"备注更新失败",icon:"none"})}finally{ye()}}}(e)},{default:u((()=>[m(f(fe(e.username,"remark")?"处理中...":"备注"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn",disabled:q.value||fe(e.username,"password"),onClick:a=>async function(e){const a=await ge({title:"重置密码",placeholder:"请输入新的登录密码"});if(null!==a)if(a){pe(e.username,"password");try{const l=await U.updateAgentPassword({username:e.username,password:a});w({title:l||"密码已重置",icon:"success"})}catch(l){console.error("openPassword error",l),w({title:"密码重置失败",icon:"none"})}finally{ye()}}else w({title:"密码不能为空",icon:"none"})}(e)},{default:u((()=>[m(f(fe(e.username,"password")?"处理中...":"重置密码"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn",disabled:q.value||fe(e.username,"cardTypes"),onClick:a=>async function(e){try{z.value.length||await U.loadCardTypes()}catch(n){console.error("loadCardTypes error",n)}const a=z.value.map((e=>e.name)),l=a.length?`可选：${a.slice(0,6).join("、")}`:"请输入卡种名称，逗号分隔",t=await ge({title:"配置授权卡种",placeholder:l,defaultValue:e.cardTypes.join(","),optional:!0});if(null===t)return;const s=t?t.split(/[，,\s]+/).map((e=>e.trim())).filter((e=>e.length>0)):[];pe(e.username,"cardTypes");try{const a=await U.assignAgentCardTypes({username:e.username,cardTypes:s});w({title:a||"卡种配置成功",icon:"success"})}catch(n){console.error("openAssignCardTypes error",n),w({title:"卡种配置失败",icon:"none"})}finally{ye()}}(e)},{default:u((()=>[m(f(fe(e.username,"cardTypes")?"处理中...":"卡种配置"),1)])),_:2},1032,["disabled","onClick"]),d(s,{class:"action-btn danger",disabled:q.value||fe(e.username,"delete"),onClick:a=>async function(e){if(await Te(`确认删除代理：${e.username}？此操作不可恢复。`)){pe(e.username,"delete");try{const a=await U.deleteAgents([e.username]);w({title:a||"已删除",icon:"success"})}catch(a){console.error("deleteAgent error",a),w({title:"删除失败",icon:"none"})}finally{ye()}}}(e)},{default:u((()=>[m(f(fe(e.username,"delete")?"处理中...":"删除"),1)])),_:2},1032,["disabled","onClick"])])),_:2},1024)])),_:1},8,["subtitle","rows","loading"]),re.value>1||k(L)?(i(),o(t,{key:0,class:"pagination glass-card"},{default:u((()=>[d(t,{class:"page-info"},{default:u((()=>[m("第 "+f(se.value)+" / "+f(re.value)+" 页 · 共 "+f(k(L))+" 条",1)])),_:1}),d(t,{class:"page-actions"},{default:u((()=>[d(s,{class:"page-btn",disabled:se.value<=1||q.value,onClick:a[1]||(a[1]=e=>_e(se.value-1))},{default:u((()=>[m("上一页")])),_:1},8,["disabled"]),d(s,{class:"page-btn",disabled:se.value>=re.value||q.value,onClick:a[2]||(a[2]=e=>_e(se.value+1))},{default:u((()=>[m("下一页")])),_:1},8,["disabled"])])),_:1})])),_:1})):v("",!0),Q.value?(i(),o(t,{key:1,class:"agent-create-modal",onClick:de},{default:u((()=>[d(t,{class:"agent-create-panel glass-card",onClick:a[9]||(a[9]=p((()=>{}),["stop"]))},{default:u((()=>[d(t,{class:"agent-create-header"},{default:u((()=>[d(l,{class:"agent-create-title"},{default:u((()=>[m("创建代理")])),_:1}),d(s,{class:"agent-create-close",disabled:K.value,onClick:de},{default:u((()=>[m("关闭")])),_:1},8,["disabled"])])),_:1}),d(t,{class:"agent-create-body"},{default:u((()=>[d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("代理账号")])),_:1}),d(n,{class:"agent-create-input",modelValue:Z.username,"onUpdate:modelValue":a[3]||(a[3]=e=>Z.username=e),placeholder:"请输入代理账号"},null,8,["modelValue"])])),_:1}),d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("初始密码")])),_:1}),d(n,{class:"agent-create-input",password:"",modelValue:Z.password,"onUpdate:modelValue":a[4]||(a[4]=e=>Z.password=e),placeholder:"请输入初始密码"},null,8,["modelValue"])])),_:1}),d(t,{class:"agent-create-grid"},{default:u((()=>[d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("初始余额(元)")])),_:1}),d(n,{class:"agent-create-input",type:"digit",modelValue:Z.balance,"onUpdate:modelValue":a[5]||(a[5]=e=>Z.balance=e),placeholder:"如 0"},null,8,["modelValue"])])),_:1}),d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("时间库存(小时)")])),_:1}),d(n,{class:"agent-create-input",type:"digit",modelValue:Z.timeStock,"onUpdate:modelValue":a[6]||(a[6]=e=>Z.timeStock=e),placeholder:"如 0"},null,8,["modelValue"])])),_:1}),d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("折扣(默认100)")])),_:1}),d(n,{class:"agent-create-input",type:"number",modelValue:Z.parities,"onUpdate:modelValue":a[7]||(a[7]=e=>Z.parities=e),placeholder:"100 表示不打折"},null,8,["modelValue"])])),_:1})])),_:1}),d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("备注信息")])),_:1}),d(c,{class:"agent-create-textarea",modelValue:Z.remark,"onUpdate:modelValue":a[8]||(a[8]=e=>Z.remark=e),placeholder:"可填写备注，留空则不设置","auto-height":""},null,8,["modelValue"])])),_:1}),d(t,{class:"agent-create-field"},{default:u((()=>[d(l,{class:"agent-create-label"},{default:u((()=>[m("授权卡种")])),_:1}),d(t,{class:"agent-create-checkboxes"},{default:u((()=>[ee.value.length?(i(),o($,{key:1,value:Z.cardTypes,onChange:me},{default:u((()=>[(i(!0),y(b,null,g(ee.value,(e=>(i(),o(j,{key:e.name,class:"agent-create-checkbox"},{default:u((()=>[d(_,{value:e.name},null,8,["value"]),d(l,{class:"agent-create-checkbox-label"},{default:u((()=>[m(f(e.label),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1},8,["value"])):(i(),o(l,{key:0,class:"agent-create-hint"},{default:u((()=>[m("暂无卡种，可稍后在详情中配置")])),_:1}))])),_:1})])),_:1})])),_:1}),d(t,{class:"agent-create-actions"},{default:u((()=>[d(s,{class:"btn ghost",disabled:K.value,onClick:de},{default:u((()=>[m("取消")])),_:1},8,["disabled"]),d(s,{class:"btn primary",disabled:K.value,onClick:Se},{default:u((()=>[m(f(K.value?"创建中...":"确认创建"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):v("",!0)])),_:1})}}}),[["__scopeId","data-v-eb00d1aa"]]);export{R as default};

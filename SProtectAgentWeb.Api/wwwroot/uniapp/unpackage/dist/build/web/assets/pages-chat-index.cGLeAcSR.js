import{d as e,D as a,x as s,h as l,r as t,z as n,y as i,o,c,w as u,a as r,b as d,t as f,l as m,B as v,F as p,k as g,E as y,s as h,$ as _,p as k,R as w,T as C,a0 as b,i as x,e as S,f as F,S as P,U as j,I as V,j as L,H as M,C as N,a1 as T,a2 as R,a3 as U,a4 as D,_ as I}from"./index-fvgcSFN3.js";import{S as $}from"./SoftwarePicker.DipzdVn_.js";import{d as E}from"./download.Brjt8TQ-.js";const G=I(e({__name:"index",setup(e){const I=a(),{chatSessions:G,chatContacts:H,selectedSoftware:z}=s(I),A=l((()=>G.value)),B=l((()=>H.value)),O=l((()=>I.loading.chat)),q=l((()=>I.loading.chatMessages)),J=t(""),K=t(""),Q=t(!1),W=t(""),X=l((()=>A.value.find((e=>e.id===J.value))??null)),Y=["😀","😁","😂","🤣","😊","😍","🤔","👍","🎉","🔥","❤️","🚀","🙏","😎","🥳"],Z=t(!1),ee=t(!1),ae=t(!1),se=t(""),le=t(""),te=t([]);async function ne(e){await I.loadChatMessages(e),oe()}function ie(){var e;J.value&&A.value.some((e=>e.id===J.value))||(J.value=(null==(e=A.value[0])?void 0:e.id)??"")}function oe(){M((()=>{const e=X.value;e&&e.messages.length?W.value=e.messages[e.messages.length-1].id:W.value=""}))}async function ce(){var e;if(await I.ensureReady(),!z.value)return void h({title:"请先选择软件位",icon:"none"});const a=B.value.length?B.value:await I.loadChatContacts(!0);if(a&&a.length)try{const e=await new Promise(((e,s)=>{_({itemList:a.map((e=>`${e.displayName}${e.displayName!==e.username?`（${e.username}）`:""}`)),success:e,fail:s})})),s=a[e.tapIndex];if(!s)return;const l=await new Promise(((e,a)=>{k({title:"发送首条消息",editable:!0,placeholderText:"输入要发送的内容",confirmText:"发送",cancelText:"取消",success:e,fail:a})}));if(!l.confirm||!l.content||!l.content.trim())return;w({title:"创建中...",mask:!0});const t=await I.createDirectConversation(s.username,l.content.trim());J.value=t.id,await ne(t.id),Z.value=!1,h({title:"会话已创建",icon:"success"})}catch(s){if(null==(e=null==s?void 0:s.errMsg)?void 0:e.includes("cancel"))return;console.error("startDirectSession error",s),h({title:"创建会话失败",icon:"none"})}finally{C()}else h({title:"暂无可用联系人",icon:"none"})}async function ue(){if(await I.ensureReady(),!z.value)return void h({title:"请先选择软件位",icon:"none"});const e=B.value.length?B.value:await I.loadChatContacts(!0);e&&e.length?(se.value="",le.value="",te.value=[],Z.value=!1,ae.value=!0):h({title:"暂无可用联系人",icon:"none"})}function re(){ae.value=!1,Z.value=!1}async function de(){const e=se.value.trim();if(e)if(te.value.length)try{w({title:"创建中...",mask:!0});const a=le.value.trim(),s=await I.createGroupConversation(e,te.value,a?{content:a}:void 0);ae.value=!1,se.value="",le.value="",te.value=[],Z.value=!1,J.value=s.id,await ne(s.id),h({title:"群聊已创建",icon:"success"})}catch(a){console.error("confirmGroupSession error",a),h({title:"创建失败",icon:"none"})}finally{C()}else h({title:"请选择成员",icon:"none"});else h({title:"请输入群聊名称",icon:"none"})}async function fe(){const e=X.value;if(e)try{w({title:"导出中...",mask:!0});const a=await I.exportChatHistory(e.id);E(a.filename,a.content),h({title:"导出完成",icon:"success"})}catch(a){console.error("exportHistory error",a),h({title:"导出失败",icon:"none"})}finally{C()}else h({title:"请先选择会话",icon:"none"})}async function me(){const e=X.value;if(!e||!K.value.trim())return;Q.value=!0;const a=K.value.trim();try{await I.sendChatMessage(e.id,a),K.value="",Z.value=!1,await ne(e.id)}finally{Q.value=!1}}function ve(){Z.value=!Z.value}function pe(e){const a=(e??"").toString().trim();a?N({data:a,success:()=>{h({title:"已复制",icon:"success",duration:800})},fail:()=>{h({title:"复制失败",icon:"none"})}}):h({title:"无可复制内容",icon:"none"})}async function ge(){var e;const a=X.value;if(a){if(!ee.value)try{const e=await new Promise(((e,a)=>{b({count:1,sizeType:["compressed","original"],success:e,fail:a})}));if(!e.tempFilePaths||!e.tempFilePaths.length)return;ee.value=!0;const s=e.tempFilePaths[0],{base64:l,fileName:t}=await async function(e,a){const s=e.tempFiles&&e.tempFiles[0];if(s&&s.file){const e=s.file,a=await new Promise(((a,s)=>{const l=new FileReader;l.onload=()=>a(l.result||""),l.onerror=()=>s(new Error("读取文件失败")),l.readAsDataURL(e)}));return{base64:a.includes(",")?a.split(",")[1]??"":a,fileName:e.name||"image.jpg"}}if("function"==typeof uni.getFileSystemManager)try{const e=uni.getFileSystemManager();return{base64:await new Promise(((s,l)=>{e.readFile({filePath:a,encoding:"base64",success:e=>s(e.data),fail:l})})),fileName:a.split("/").pop()||"image.jpg"}}catch(l){console.error("readFileSystem error",l)}return{base64:await new Promise(((e,s)=>{R({url:a,method:"GET",responseType:"arraybuffer",success:a=>{e(U(a.data))},fail:s})})),fileName:a.split("/").pop()||"image.jpg"}}(e,s),n=K.value.trim();await I.sendChatMessage(a.id,n,{type:"image",mediaBase64:l,mediaName:t,caption:n}),K.value="",Z.value=!1,await ne(a.id),h({title:"图片已发送",icon:"success"})}catch(s){if(null==(e=null==s?void 0:s.errMsg)?void 0:e.includes("cancel"))return;console.error("chooseImage error",s),h({title:"发送失败",icon:"none"})}finally{ee.value=!1}}else h({title:"请先选择会话",icon:"none"})}return n((async()=>{await I.ensureReady(),await I.loadChatContacts(),await I.loadChatSessions(),ie()})),i(A,(()=>{ie(),oe()})),i((()=>z.value),(async(e,a)=>{e&&e!==a&&(J.value="",await I.loadChatContacts(!0),await I.loadChatSessions(),ie())})),i(J,(async e=>{e&&await ne(e)})),(e,a)=>{const s=x,l=S,t=F,n=P,i=D,h=j,_=V;return o(),c(l,{class:"page"},{default:u((()=>[r(l,{class:"header glass-card"},{default:u((()=>[r(l,null,{default:u((()=>[r(s,{class:"title"},{default:u((()=>[d("即时沟通")])),_:1}),r(s,{class:"subtitle"},{default:u((()=>[d("与渠道代理实时同步巡检与协同进度")])),_:1})])),_:1}),r(l,{class:"header-actions"},{default:u((()=>[r($),r(t,{class:"header-btn",onClick:ce},{default:u((()=>[d("发起单聊")])),_:1}),r(t,{class:"header-btn ghost",onClick:ue},{default:u((()=>[d("创建群聊")])),_:1})])),_:1})])),_:1}),r(l,{class:"chat-layout"},{default:u((()=>[r(l,{class:"session-panel glass-card"},{default:u((()=>[r(l,{class:"session-header"},{default:u((()=>[r(s,{class:"session-title"},{default:u((()=>[d("会话列表")])),_:1}),r(s,{class:"session-counter"},{default:u((()=>[d(f(A.value.length)+" 个会话",1)])),_:1})])),_:1}),O.value?(o(),c(l,{key:0,class:"session-empty"},{default:u((()=>[d("加载中...")])),_:1})):A.value.length?(o(),c(n,{key:2,"scroll-y":"",class:"session-list","show-scrollbar":!1},{default:u((()=>[(o(!0),m(p,null,v(A.value,(e=>(o(),c(l,{key:e.id,class:L(["session-item",{active:e.id===J.value}]),onClick:a=>async function(e){e!==J.value&&(J.value=e,Z.value=!1)}(e.id)},{default:u((()=>[r(l,{class:"session-title-row"},{default:u((()=>[r(s,{class:"session-name"},{default:u((()=>[d(f(e.title),1)])),_:2},1024),e.unread?(o(),c(l,{key:0,class:"session-unread"},{default:u((()=>[d(f(e.unread),1)])),_:2},1024)):g("",!0)])),_:2},1024),r(s,{class:"session-preview"},{default:u((()=>[d(f(e.preview||"暂未开始对话"),1)])),_:2},1024),r(s,{class:"session-time"},{default:u((()=>[d(f(e.updatedAt),1)])),_:2},1024)])),_:2},1032,["class","onClick"])))),128))])),_:1})):(o(),c(l,{key:1,class:"session-empty"},{default:u((()=>[d("暂无会话，点击右上角即可创建")])),_:1}))])),_:1}),r(l,{class:"chat-panel glass-card"},{default:u((()=>[X.value?(o(),c(l,{key:1,class:"chat-body"},{default:u((()=>[r(l,{class:"chat-meta"},{default:u((()=>[r(l,null,{default:u((()=>[r(s,{class:"chat-title"},{default:u((()=>[d(f(X.value.title),1)])),_:1}),r(s,{class:"chat-subtitle"},{default:u((()=>[d(f(X.value.participants.join("、")),1)])),_:1})])),_:1}),r(t,{class:"chat-action",onClick:fe},{default:u((()=>[d("导出记录")])),_:1})])),_:1}),r(n,{"scroll-y":"",class:"message-list","show-scrollbar":!1,"scroll-into-view":W.value},{default:u((()=>[(o(!0),m(p,null,v(X.value.messages,(e=>(o(),c(l,{key:e.id,id:e.id,class:L(["message","user"===e.sender?"self":"system"])},{default:u((()=>["image"===e.type?(o(),m(p,{key:0},[r(i,{class:"message-image",mode:"widthFix",src:e.content,onClick:a=>{var s;(s=e.content)&&T({urls:[s]})}},null,8,["src","onClick"]),e.caption?(o(),c(s,{key:0,class:"message-caption copyable",onLongpress:a=>pe(e.caption),onClick:y((a=>pe(e.caption)),["stop"])},{default:u((()=>[d(f(e.caption),1)])),_:2},1032,["onLongpress","onClick"])):g("",!0)],64)):(o(),c(s,{key:1,class:"message-content copyable",onLongpress:a=>pe(e.content),onClick:y((a=>pe(e.content)),["stop"])},{default:u((()=>[d(f(e.content),1)])),_:2},1032,["onLongpress","onClick"])),r(s,{class:"message-time copyable",onLongpress:a=>pe(e.time),onClick:y((a=>pe(e.time)),["stop"])},{default:u((()=>[d(f(e.time),1)])),_:2},1032,["onLongpress","onClick"])])),_:2},1032,["id","class"])))),128)),q.value?(o(),c(l,{key:0,class:"message-loading"},{default:u((()=>[d("消息加载中...")])),_:1})):g("",!0)])),_:1},8,["scroll-into-view"]),r(l,{class:"composer glass-light"},{default:u((()=>[r(l,{class:"composer-toolbar"},{default:u((()=>[r(t,{class:"tool-btn",onClick:ve},{default:u((()=>[d("😊")])),_:1}),r(t,{class:"tool-btn",disabled:Q.value||ee.value,onClick:ge},{default:u((()=>[d("📎")])),_:1},8,["disabled"])])),_:1}),r(h,{modelValue:K.value,"onUpdate:modelValue":a[0]||(a[0]=e=>K.value=e),class:"composer-input",placeholder:"输入消息内容，支持快捷同步巡检结果",maxlength:500,"auto-height":""},null,8,["modelValue"]),Z.value?(o(),c(l,{key:0,class:"emoji-panel"},{default:u((()=>[(o(),m(p,null,v(Y,(e=>r(s,{key:e,class:"emoji-item",onClick:a=>function(e){K.value+=e}(e)},{default:u((()=>[d(f(e),1)])),_:2},1032,["onClick"]))),64))])),_:1})):g("",!0),r(t,{class:"composer-send",disabled:!K.value.trim()||Q.value||ee.value,onClick:me},{default:u((()=>[d(f(Q.value?"发送中...":"发送消息"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})):(o(),c(l,{key:0,class:"chat-empty"},{default:u((()=>[d(" 请选择左侧会话或点击“新建会话”发起沟通 ")])),_:1}))])),_:1})])),_:1}),ae.value?(o(),c(l,{key:0,class:"group-modal",onClick:re},{default:u((()=>[r(l,{class:"group-panel glass-card",onClick:a[3]||(a[3]=y((()=>{}),["stop"]))},{default:u((()=>[r(l,{class:"group-header"},{default:u((()=>[r(s,{class:"group-title"},{default:u((()=>[d("创建群聊")])),_:1}),r(t,{class:"group-close",onClick:re},{default:u((()=>[d("关闭")])),_:1})])),_:1}),r(_,{class:"group-input",modelValue:se.value,"onUpdate:modelValue":a[1]||(a[1]=e=>se.value=e),placeholder:"请输入群聊名称"},null,8,["modelValue"]),r(h,{class:"group-textarea",modelValue:le.value,"onUpdate:modelValue":a[2]||(a[2]=e=>le.value=e),placeholder:"首条消息（可选）","auto-height":""},null,8,["modelValue"]),r(n,{"scroll-y":"",class:"group-list","show-scrollbar":!1},{default:u((()=>[(o(!0),m(p,null,v(B.value,(e=>(o(),c(l,{key:e.username,class:L(["group-item",{selected:te.value.includes(e.username)}]),onClick:a=>function(e){if(!e)return;const a=[...te.value],s=a.indexOf(e);s>=0?a.splice(s,1):a.push(e),te.value=a}(e.username)},{default:u((()=>[r(s,{class:"group-name"},{default:u((()=>[d(f(e.displayName),1)])),_:2},1024),r(s,{class:"group-username"},{default:u((()=>[d(f(e.username),1)])),_:2},1024),e.remark?(o(),c(s,{key:0,class:"group-remark"},{default:u((()=>[d(f(e.remark),1)])),_:2},1024)):g("",!0)])),_:2},1032,["class","onClick"])))),128))])),_:1}),r(l,{class:"group-actions"},{default:u((()=>[r(t,{class:"group-btn",disabled:!se.value||!se.value.trim()||!te.value.length,onClick:de},{default:u((()=>[d(" 创建 ")])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})):g("",!0)])),_:1})}}}),[["__scopeId","data-v-71a95eb5"]]);export{G as default};

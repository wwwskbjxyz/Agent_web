import{d as e,D as a,u as t,x as l,G as s,r as n,h as u,y as o,a5 as r,o as i,c as d,w as c,a as f,b as v,t as g,k as y,A as w,j as m,l as p,B as h,F as _,s as C,C as b,n as k,a6 as N,a7 as x,a8 as A,a9 as D,i as $,e as U,f as I,v as L,I as S,_ as B}from"./index-fvgcSFN3.js";const R=B(e({__name:"index",setup(e){const B=a(),R=t(),{verification:T}=l(B),{selectedSoftware:F,softwareList:O}=l(B),{bindings:V,selectedBinding:j}=l(R),E="undefined"!=typeof uni&&"function"==typeof s?s():null,P=((null==E?void 0:E.uniPlatform)||"").toLowerCase().startsWith("mp"),W="undefined"!=typeof window&&"undefined"!=typeof document,G=n(""),J=n(""),q=n(null),z=n(null),H=n(""),K=n(null),M=n(""),Q=n(""),X=u((()=>T.value)),Y=u((()=>B.loading.verification)),Z=u((()=>!z.value)),ee=u((()=>{const e=ce.value;return!!e&&!!e.softwareCode&&!H.value})),ae=u((()=>V.value.map((e=>({value:e.bindingId,label:`${e.authorDisplayName} (${e.softwareCode})`}))))),te=u((()=>O.value.map((e=>({value:e.softwareName,label:e.softwareName}))))),le=u((()=>W?"分享链接":"分享路径")),se=u((()=>J.value?`/pages/verify/share?${J.value}`:"")),ne=u((()=>J.value?W&&"undefined"!=typeof window&&window.location?`${window.location.origin}/#/pages/verify/share?${J.value}`:se.value:"")),ue=u((()=>W?ne.value:se.value)),oe=u((()=>"generated"===q.value)),re=u((()=>!!J.value)),ie=u((()=>oe.value&&re.value)),de=u((()=>{var e,a,t;if(!Z.value)return null;const l=(M.value||F.value||"").trim();if(!l)return null;const s=V.value.find((e=>e.bindingId===K.value))||j.value;return{software:l,softwareCode:(null==(e=null==s?void 0:s.softwareCode)?void 0:e.trim())||void 0,agentAccount:(null==(t=null==(a=R.agent)?void 0:a.username)?void 0:t.trim())||void 0,displayName:l}})),ce=u((()=>z.value??de.value)),fe=u((()=>{var e,a;return(null==(e=ce.value)?void 0:e.displayName)||(null==(a=ce.value)?void 0:a.software)||"未选择"})),ve=u((()=>{var e;return(null==(e=ce.value)?void 0:e.softwareCode)||""})),ge=u((()=>{var e,a;return(null==(e=ce.value)?void 0:e.agentDisplayName)||(null==(a=ce.value)?void 0:a.agentAccount)||""})),ye=u((()=>{if(!Z.value)return ve.value||"未提供绑定信息";const e=ae.value.find((e=>e.value===K.value));return(null==e?void 0:e.label)||"请选择绑定软件码"})),we=u((()=>{if(!Z.value)return fe.value;const e=te.value.find((e=>e.value===M.value));return(null==e?void 0:e.label)||"请选择软件位"}));function me(e){var a;const t=Number((null==(a=null==e?void 0:e.detail)?void 0:a.value)??0),l=ae.value[t];K.value=(null==l?void 0:l.value)??null}function pe(e){var a;const t=Number((null==(a=null==e?void 0:e.detail)?void 0:a.value)??0),l=te.value[t];M.value=(null==l?void 0:l.value)??""}function he(){if(!G.value.trim())return void C({title:"请输入卡密",icon:"none"});if(!ee.value){const e=H.value||"未选择软件位，无法验证";return void C({title:e,icon:"none"})}const e=ce.value;e?B.loadVerification(G.value.trim(),e):C({title:"未选择软件位，无法验证",icon:"none"})}function _e(e){e?b({data:e,success:()=>{C({title:"链接已复制",icon:"success"})}}):C({title:"暂无链接可复制",icon:"none"})}function Ce(){ie.value&&ue.value?_e(ue.value):C({title:"暂无分享信息",icon:"none"})}function be(){se.value?k({url:se.value}):C({title:"暂无分享路径",icon:"none"})}function ke(){const e=de.value;if(!e)return void C({title:"请先选择绑定和软件位",icon:"none"});const a=V.value.find((e=>e.bindingId===K.value))||j.value;if(e.softwareCode)J.value=Ue(e),q.value="generated",H.value="",C({title:W?"已生成分享链接":"已生成分享路径",icon:"success"});else{const e=(null==a?void 0:a.softwareCode)?`（${a.softwareCode}）`:"";C({title:`绑定缺少软件码${e}`,icon:"none"})}}function Ne(e){const a={};let t=!1;if(!e)return{detected:!1,candidate:a};const l=(...e)=>{for(const a of e){const e=s(a);if(e)return e}return""},s=a=>{const t=e[a];if("string"==typeof t&&t.trim())return De(t);const l=a.toLowerCase();if(l!==a){const a=e[l];if("string"==typeof a&&a.trim())return De(a)}return""},n=$e(l("software","s","softwareName","slot"));n&&(a.software=n,t=!0);const u=$e(l("display","softwareDisplay","softwareDisplayName","name"));u&&(a.softwareDisplayName=u,t=!0);const o=$e(l("code","c","softwareCode","binding"));o&&(a.softwareCode=o,t=!0);const r=$e(l("agent","a","agentAccount"));r&&(a.agentAccount=r,t=!0);const i=$e(l("agentName","agentDisplay","agentDisplayName"));i&&(a.agentDisplayName=i,t=!0);const d=$e(l("gateway","api","gw"));if(d){t=!0;const e=Ie(d);e&&(a.gateway=e)}const c=$e(l("share","context","slug","token"));return c&&(a.slug=c,t=!0),{detected:t,candidate:a}}async function xe(){var e;if("function"!=typeof N)return{detected:!1,candidate:{}};const a=N();if(!Array.isArray(a)||!a.length)return{detected:!1,candidate:{}};const t=a[a.length-1],l=(null==(e=null==t?void 0:t.$page)?void 0:e.fullPath)||(null==t?void 0:t.route)||"";if(!l)return{detected:!1,candidate:{}};const s=l.indexOf("?");if(s>=0){return Ne(function(e){const a={};if(!e)return a;return e.split("&").forEach((e=>{if(!e)return;const[t,l=""]=e.split("="),s=(t||"").trim();if(!s)return;const n=De(l);a[s]=n;const u=s.toLowerCase();u!==s&&null==a[u]&&(a[u]=n)})),a}(l.slice(s+1)))}const n=l.split("/").filter(Boolean);if(n.length>2){const e=De(n[n.length-1]);if(e)return Ne({share:e})}return{detected:!1,candidate:{}}}async function Ae(e){const a=e.slug?function(e){if(!e)return null;try{let a=e.replace(/-/g,"+").replace(/_/g,"/");const t=a.length%4;let l;if(t&&(a=a.padEnd(a.length+(4-t),"=")),"undefined"!=typeof uni&&"function"==typeof D)l=D(a);else if("function"==typeof atob){const e=atob(a),t=new Uint8Array(e.length);for(let a=0;a<e.length;a++)t[a]=e.charCodeAt(a);l=t.buffer}else{if("undefined"==typeof Buffer)return null;{const e=Buffer.from(a,"base64");l=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}}const s="undefined"!=typeof TextDecoder?(new TextDecoder).decode(new Uint8Array(l)):function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let a="";for(let t=0;t<e.length;){const l=e[t++];if(l<128)a+=String.fromCharCode(l);else if(l<224){const s=e[t++];a+=String.fromCharCode((31&l)<<6|63&s)}else if(l<240){const s=e[t++],n=e[t++];a+=String.fromCharCode((15&l)<<12|(63&s)<<6|63&n)}else{const s=((7&l)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,n=55296+(s>>10),u=56320+(1023&s);a+=String.fromCharCode(n,u)}}return a}(new Uint8Array(l)),n=JSON.parse(s)??{},u=$e(n.s||n.software||n.softwareName||n.slot),o=$e(n.c||n.code||n.softwareCode||n.binding),r=$e(n.a||n.agent||n.agentAccount),i=Ie($e(n.g||n.gateway));return u&&o?{software:u,softwareCode:o,agentAccount:r||void 0,gateway:i||void 0}:null}catch(a){return console.warn("Failed to decode legacy share slug",a),null}}(e.slug):null,t=Ie(e.gateway)||Ie(null==a?void 0:a.gateway),l=$e(e.software)||$e(null==a?void 0:a.software),s=$e(e.softwareCode)||$e(null==a?void 0:a.softwareCode),n=$e(e.agentAccount)||$e(null==a?void 0:a.agentAccount),u=$e(e.softwareDisplayName),o=$e(e.agentDisplayName);if(l&&s)return{software:l,softwareCode:s,agentAccount:n||void 0,displayName:u||l,agentDisplayName:o||void 0,gateway:t||void 0};if(!s)return null;const r=await async function(e,a){const t=$e(e);if(!t)return null;const l=a?`${a}/api/card-verification/context`:"/api/card-verification/context";try{const e=await x({url:l,method:"GET",data:{softwareCode:t},skipProxy:!0,auth:!1});return e||null}catch(s){return console.warn("Failed to load verification context",s),null}}(s,t||void 0);if(!r)return null;const i=$e(r.software),d=$e(r.softwareCode)||s;return i?{software:i,softwareCode:d,agentAccount:n||$e(r.agentAccount)||void 0,displayName:u||$e(r.softwareDisplayName)||i,agentDisplayName:o||$e(r.agentDisplayName)||void 0,gateway:t||void 0}:null}function De(e){if("string"!=typeof e)return"";try{return decodeURIComponent(e)}catch(a){return e}}function $e(e){return"string"!=typeof e?"":e.trim()}function Ue(e){const a=[`software=${encodeURIComponent(e.software)}`];e.softwareCode&&a.push(`code=${encodeURIComponent(e.softwareCode)}`),e.agentAccount&&a.push(`agent=${encodeURIComponent(e.agentAccount)}`);const t=Ie(e.gateway||Q.value);return t&&a.push(`gateway=${encodeURIComponent(t)}`),a.join("&")}function Ie(e){if(!e)return"";const a=e.trim();if(!a)return"";const t=a.toLowerCase();return t.startsWith("http://")||t.startsWith("https://")?a.replace(/\/+$/,""):""}o(V,(e=>{Z.value&&e.length>0&&null==K.value&&(K.value=e[0].bindingId)}),{immediate:!0}),o(j,(e=>{Z.value&&e&&null==K.value&&(K.value=e.bindingId)}),{immediate:!0}),o(F,(e=>{Z.value&&!M.value&&e&&(M.value=e)}),{immediate:!0}),o(ae,(e=>{Z.value&&(e.length?e.some((e=>e.value===K.value))||(K.value=e[0].value):K.value=null)}),{immediate:!0}),o(te,(e=>{Z.value&&(e.length?e.some((e=>e.value===M.value))||(M.value=e[0].value):M.value="")}),{immediate:!0}),o([K,M],(()=>{"generated"===q.value&&(J.value="",q.value=null)})),r((async e=>{q.value=null,J.value="",H.value="",z.value=null;let a=Ne(e);if(a.detected||(a=await xe()),a.detected){q.value="link",H.value="链接解析中，请稍候";try{const e=await Ae(a.candidate);e?function(e){const a=Ie(e.gateway);a&&(Q.value=a,A(a));const t={software:e.software,softwareCode:e.softwareCode,agentAccount:e.agentAccount,displayName:e.displayName||e.software,agentDisplayName:e.agentDisplayName||e.agentAccount,gateway:a||void 0};z.value=t,J.value=Ue(t),T.value=null,H.value="",G.value="",q.value="link"}(e):H.value="链接信息缺失或已失效，请联系代理重新生成"}catch(t){console.warn("Failed to resolve share link context",t),H.value="解析分享信息失败，请稍后再试"}}}));const Le=u((()=>{var e;switch(null==(e=X.value)?void 0:e.status){case"success":return{title:"验证成功",statusClass:"status-success"};case"warning":return{title:"请注意",statusClass:"status-warning"};case"error":return{title:"验证失败",statusClass:"status-error"};default:return{title:"提醒",statusClass:"status-info"}}})),Se=u((()=>W?"复制链接分享给用户":"复制或打开小程序路径"));return(e,a)=>{const t=$,l=U,s=I,n=L,u=S;return i(),d(l,{class:"page"},{default:c((()=>[f(l,{class:"header glass-card"},{default:c((()=>[f(l,null,{default:c((()=>[f(t,{class:"title"},{default:c((()=>[v("卡密验证与资源下载")])),_:1}),f(t,{class:"subtitle"},{default:c((()=>[v("输入卡密后自动校验授权状态并生成下载链接")])),_:1})])),_:1})])),_:1}),f(l,{class:"context-card glass-card"},{default:c((()=>[f(l,{class:"context-header"},{default:c((()=>[f(t,{class:"context-label"},{default:c((()=>[v("当前软件位")])),_:1}),f(t,{class:"context-value"},{default:c((()=>[v(g(fe.value),1)])),_:1})])),_:1}),ve.value?(i(),d(l,{key:0,class:"context-sub"},{default:c((()=>[v("绑定码："+g(ve.value),1)])),_:1})):y("",!0),ge.value?(i(),d(l,{key:1,class:"context-sub"},{default:c((()=>[v("所属代理："+g(ge.value),1)])),_:1})):y("",!0),H.value?(i(),d(l,{key:2,class:"context-sub error"},{default:c((()=>[v(g(H.value),1)])),_:1})):y("",!0),!H.value&&ie.value?(i(),d(l,{key:3,class:"context-share"},{default:c((()=>[f(t,{class:"share-label"},{default:c((()=>[v(g(le.value),1)])),_:1}),f(l,{class:"share-row"},{default:c((()=>[f(t,{class:"share-url",onClick:Ce},{default:c((()=>[v(g(ue.value),1)])),_:1}),f(s,{class:"share-btn",onClick:Ce},{default:c((()=>[v("复制")])),_:1}),w(P)?(i(),d(s,{key:0,class:"share-btn ghost",onClick:be},{default:c((()=>[v("打开")])),_:1})):y("",!0)])),_:1}),f(t,{class:"share-hint"},{default:c((()=>[v(g(Se.value),1)])),_:1})])),_:1})):y("",!0)])),_:1}),Z.value?(i(),d(l,{key:0,class:"generator-card glass-card"},{default:c((()=>[f(t,{class:"section-title"},{default:c((()=>[v("生成分享链接")])),_:1}),f(l,{class:"field"},{default:c((()=>[f(t,{class:"field-label"},{default:c((()=>[v("绑定的软件码")])),_:1}),f(n,{mode:"selector",range:ae.value,"range-key":"label",onChange:me},{default:c((()=>[f(l,{class:"picker-value"},{default:c((()=>[v(g(ye.value),1)])),_:1})])),_:1},8,["range"])])),_:1}),f(l,{class:"field"},{default:c((()=>[f(t,{class:"field-label"},{default:c((()=>[v("软件位")])),_:1}),f(n,{mode:"selector",range:te.value,"range-key":"label",onChange:pe},{default:c((()=>[f(l,{class:"picker-value"},{default:c((()=>[v(g(we.value),1)])),_:1})])),_:1},8,["range"])])),_:1}),f(l,{class:"generator-actions"},{default:c((()=>[f(s,{class:"secondary",disabled:!de.value,onClick:ke},{default:c((()=>[v(" 生成分享"+g(w(W)?"链接":"路径"),1)])),_:1},8,["disabled"]),ie.value&&oe.value?(i(),d(s,{key:0,class:"secondary ghost",onClick:Ce},{default:c((()=>[v(" 复制"+g(w(W)?"链接":"路径"),1)])),_:1})):y("",!0),ie.value&&oe.value&&w(P)?(i(),d(s,{key:1,class:"secondary ghost",onClick:be},{default:c((()=>[v(" 打开页面 ")])),_:1})):y("",!0)])),_:1}),ie.value&&oe.value?(i(),d(l,{key:0,class:"share-preview"},{default:c((()=>[v(g(ue.value),1)])),_:1})):y("",!0)])),_:1})):y("",!0),f(l,{class:"verify-card glass-card"},{default:c((()=>[f(l,{class:"form"},{default:c((()=>[f(t,{class:"form-label"},{default:c((()=>[v("卡密")])),_:1}),f(u,{modelValue:G.value,"onUpdate:modelValue":a[0]||(a[0]=e=>G.value=e),class:"form-input",placeholder:"请输入需要验证的卡密编号","confirm-type":"done"},null,8,["modelValue"]),f(s,{class:"form-submit",disabled:Y.value||!ee.value,onClick:he},{default:c((()=>[v(g(Y.value?"验证中...":"立即验证"),1)])),_:1},8,["disabled"])])),_:1}),X.value?(i(),d(l,{key:0,class:"result"},{default:c((()=>[f(l,{class:m(["status-banner",Le.value.statusClass])},{default:c((()=>[f(t,{class:"status-title"},{default:c((()=>[v(g(Le.value.title),1)])),_:1}),f(t,{class:"status-message"},{default:c((()=>[v(g(X.value.message),1)])),_:1})])),_:1},8,["class"]),X.value.stats?(i(),d(l,{key:0,class:"stats"},{default:c((()=>[f(l,{class:"stat glass-light"},{default:c((()=>[f(t,{class:"stat-label"},{default:c((()=>[v("验证次数")])),_:1}),f(t,{class:"stat-value"},{default:c((()=>[v(g(X.value.stats.attemptNumber),1)])),_:1})])),_:1}),f(l,{class:"stat glass-light"},{default:c((()=>[f(t,{class:"stat-label"},{default:c((()=>[v("剩余下载")])),_:1}),f(t,{class:"stat-value"},{default:c((()=>[v(g(X.value.stats.remainingDownloads),1)])),_:1})])),_:1}),X.value.stats.expiresAt?(i(),d(l,{key:0,class:"stat glass-light"},{default:c((()=>[f(t,{class:"stat-label"},{default:c((()=>[v("有效期")])),_:1}),f(t,{class:"stat-value"},{default:c((()=>[v(g(X.value.stats.expiresAt),1)])),_:1})])),_:1})):y("",!0)])),_:1})):y("",!0),X.value.downloadUrl?(i(),d(l,{key:1,class:"download"},{default:c((()=>[f(t,{class:"download-label"},{default:c((()=>[v("资源包下载地址")])),_:1}),f(l,{class:"download-row"},{default:c((()=>[f(t,{class:"download-url",onClick:a[1]||(a[1]=e=>_e(X.value.downloadUrl))},{default:c((()=>[v(g(X.value.downloadUrl),1)])),_:1}),f(s,{class:"download-btn",onClick:a[2]||(a[2]=e=>_e(X.value.downloadUrl))},{default:c((()=>[v("复制链接")])),_:1})])),_:1}),X.value.extractionCode?(i(),d(t,{key:0,class:"download-code"},{default:c((()=>[v("提取码："+g(X.value.extractionCode),1)])),_:1})):y("",!0)])),_:1})):y("",!0),f(l,{class:"history"},{default:c((()=>[f(t,{class:"history-title"},{default:c((()=>[v("下载记录")])),_:1}),X.value.history.length?(i(),d(l,{key:1,class:"history-list"},{default:c((()=>[(i(!0),p(_,null,h(X.value.history,(e=>(i(),d(l,{key:e.id,class:"history-item glass-light"},{default:c((()=>[f(l,{class:"history-row"},{default:c((()=>[f(t,{class:"history-label"},{default:c((()=>[v("链接")])),_:1}),f(t,{class:"history-value"},{default:c((()=>[v(g(e.url),1)])),_:2},1024)])),_:2},1024),f(l,{class:"history-row"},{default:c((()=>[f(t,{class:"history-label"},{default:c((()=>[v("提取码")])),_:1}),f(t,{class:"history-value"},{default:c((()=>[v(g(e.extractionCode||"—"),1)])),_:2},1024)])),_:2},1024),f(l,{class:"history-row"},{default:c((()=>[f(t,{class:"history-label"},{default:c((()=>[v("分配时间")])),_:1}),f(t,{class:"history-value"},{default:c((()=>[v(g(e.assignedAt),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(i(),d(l,{key:0,class:"history-empty"},{default:c((()=>[v("暂无下载记录")])),_:1}))])),_:1})])),_:1})):y("",!0)])),_:1})])),_:1})}}}),[["__scopeId","data-v-c84e9ed0"]]);export{R as default};

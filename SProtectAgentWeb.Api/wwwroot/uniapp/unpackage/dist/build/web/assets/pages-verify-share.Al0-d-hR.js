import{d as a,D as e,x as t,r as s,h as l,a5 as o,a8 as n,a6 as r,a7 as u,a9 as i,o as c,c as f,w as d,a as v,b as w,t as y,k as g,j as p,l as m,B as _,F as h,s as C,C as D,i as b,e as N,I as x,f as A,_ as k}from"./index-DVWvtVDx.js";const U=k(a({__name:"share",setup(a){const k=e(),{verification:U}=t(k),B=s(""),S=s(""),F=s(""),O=s(""),V=s(""),E=s(""),I=s(""),T=l((()=>k.loading.verification)),j=l((()=>U.value)),L=l((()=>S.value||B.value)),P=l((()=>V.value||O.value||"")),W=l((()=>!!B.value&&!!F.value)),$=l((()=>W.value&&!!I.value.trim()&&!T.value)),G=l((()=>{var a;switch(null==(a=j.value)?void 0:a.status){case"success":return{title:"验证成功",statusClass:"status-success"};case"warning":return{title:"请注意",statusClass:"status-warning"};case"error":return{title:"验证失败",statusClass:"status-error"};default:return{title:"提醒",statusClass:"status-info"}}}));function J(){I.value.trim()?W.value?k.loadVerification(I.value.trim(),{software:B.value,softwareCode:F.value,agentAccount:O.value||void 0}):C({title:E.value||"链接信息缺失",icon:"none"}):C({title:"请输入卡密",icon:"none"})}function R(a){a?D({data:a,success:()=>{C({title:"链接已复制",icon:"success"})}}):C({title:"暂无链接可复制",icon:"none"})}async function q(a){if(!a)return null;const e=M(a.gateway??""),t=z(a.softwareCode),s=z(a.software),l=z(a.softwareDisplayName),o=z(a.agentAccount),n=z(a.agentDisplayName);if(s&&t)return{software:s,softwareCode:t,softwareDisplayName:l||s,agentAccount:o||void 0,agentDisplayName:n||void 0,gateway:e||void 0};if(!t)return null;const r=await async function(a){const e=z(a);if(!e)return null;try{const a=await u({url:"/api/card-verification/context",method:"GET",data:{softwareCode:e},skipProxy:!0,auth:!1});return a?{software:z(a.software)||void 0,softwareCode:z(a.softwareCode)||e,softwareDisplayName:z(a.softwareDisplayName)||void 0,agentAccount:z(a.agentAccount)||void 0,agentDisplayName:z(a.agentDisplayName)||void 0}:null}catch(t){return console.warn("Failed to load verification context",t),null}}(t);if(!r)return null;const i=z(r.software),c=z(r.softwareCode)||t,f=z(r.softwareDisplayName),d=z(r.agentAccount),v=z(r.agentDisplayName);return i?{software:i,softwareCode:c,softwareDisplayName:l||f||i,agentAccount:o||d||void 0,agentDisplayName:n||v||void 0,gateway:e||void 0}:null}function z(a){return"string"!=typeof a?"":a.trim()}function H(a){const e=z(a);if(!e)return"";try{return decodeURIComponent(e)}catch(t){return e}}function K(a){if(!a)return null;try{let e=a.replace(/-/g,"+").replace(/_/g,"/");const t=e.length%4;t&&(e=e.padEnd(e.length+(4-t),"="));const s=function(a){if("undefined"!=typeof uni&&"function"==typeof i)return i(a);if("function"==typeof atob){const e=atob(a),t=e.length,s=new Uint8Array(t);for(let a=0;a<t;a++)s[a]=e.charCodeAt(a);return s.buffer}if("undefined"!=typeof Buffer){const e=Buffer.from(a,"base64");return e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}throw new Error("当前环境不支持 Base64 解码")}(e),l=function(a){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(a);let e="";for(let t=0;t<a.length;){const s=a[t++];if(s<128)e+=String.fromCharCode(s);else if(s<224){const l=a[t++];e+=String.fromCharCode((31&s)<<6|63&l)}else if(s<240){const l=a[t++],o=a[t++];e+=String.fromCharCode((15&s)<<12|(63&l)<<6|63&o)}else{const l=((7&s)<<18|(63&a[t++])<<12|(63&a[t++])<<6|63&a[t++])-65536,o=55296+(l>>10),n=56320+(1023&l);e+=String.fromCharCode(o,n)}}return e}(new Uint8Array(s)),o=JSON.parse(l)??{},n=z(o.s??o.software??o.softwareName??o.slot),r=z(o.c??o.code??o.softwareCode??o.binding),u=z(o.a??o.agent??o.agentAccount),c=z(o.an??o.agentName??o.agentDisplay??o.agentDisplayName),f=z(o.d??o.display??o.softwareDisplay??o.softwareDisplayName),d=M(z(o.g));return r?{software:n||void 0,softwareCode:r,agentAccount:u||void 0,agentDisplayName:c||void 0,softwareDisplayName:f||void 0,gateway:d||void 0}:null}catch(e){return console.warn("Failed to decode share slug",e),null}}function M(a){if(!a)return"";const e=a.trim();if(!e)return"";const t=e.toLowerCase();return t.startsWith("http://")||t.startsWith("https://")?e.replace(/\/+$/,""):""}return o((async a=>{E.value="链接解析中，请稍候",B.value="",S.value="",F.value="",O.value="",V.value="",U.value=null;try{const e=await async function(a){const e=await q(function(a){if(!a)return null;const e=H(a.share);if(e){const a=K(e);if(a)return a}const t=H(a.s??a.software??a.softwareName??a.slot),s=H(a.c??a.code??a.softwareCode??a.binding),l=H(a.a??a.agent??a.agentAccount),o=H(a.agentName??a.agentDisplay??a.agentDisplayName),n=H(a.display??a.softwareDisplay??a.softwareDisplayName??a.name),r=M(H(a.gateway??a.api??a.gw));if(!s)return null;return{software:t||void 0,softwareCode:s,agentAccount:l||void 0,agentDisplayName:o||void 0,softwareDisplayName:n||void 0,gateway:r||void 0}}(a));if(e)return e;return q(await async function(){var a;if("function"!=typeof r)return null;const e=r();if(!Array.isArray(e)||!e.length)return null;const t=e[e.length-1],s=(null==(a=null==t?void 0:t.$page)?void 0:a.fullPath)||"";if(!s)return null;const l=s.indexOf("?");if(l<0){const a=s.split("/").filter(Boolean);if(a.length>2){const e=K(H(a[a.length-1]));if(e)return e}return null}const o=function(a){const e={};if(!a)return e;const t=a.split("&");for(const s of t){if(!s)continue;const[a,t=""]=s.split("="),l=z(a);l&&(e[l]=t)}return e}(s.slice(l+1));if(o.share){const a=K(H(o.share));if(a)return a}const n=H(o.s||o.software||o.softwarename||o.slot||""),u=H(o.c||o.code||o.softwarecode||o.binding||""),i=H(o.a||o.agent||o.agentaccount||""),c=H(o.agentname||o.agentdisplay||o.agentdisplayname||""),f=H(o.display||o.softwaredisplay||o.softwaredisplayname||o.name||""),d=M(H(o.gateway||o.api||o.gw));if(!u)return null;return{software:n||void 0,softwareCode:u,agentAccount:i||void 0,agentDisplayName:c||void 0,softwareDisplayName:f||void 0,gateway:d||void 0}}())}(a);e?function(a){B.value=a.software,S.value=a.softwareDisplayName||a.software,F.value=a.softwareCode,O.value=a.agentAccount??"",V.value=a.agentDisplayName??"",E.value="",U.value=null,a.gateway&&n(a.gateway)}(e):E.value="链接信息缺失，请联系代理重新生成"}catch(e){console.warn("Failed to resolve share context",e),E.value="解析链接信息失败，请稍后重试"}})),(a,e)=>{const t=b,s=N,l=x,o=A;return c(),f(s,{class:"page"},{default:d((()=>[v(s,{class:"header glass-card"},{default:d((()=>[v(s,null,{default:d((()=>[v(t,{class:"title"},{default:d((()=>[w("卡密验证与资源下载")])),_:1}),v(t,{class:"subtitle"},{default:d((()=>[w(y(W.value?"输入卡密即可验证并获取下载链接":"链接缺少必要信息，请联系代理确认"),1)])),_:1})])),_:1})])),_:1}),v(s,{class:"context-card glass-card"},{default:d((()=>[v(s,{class:"context-row"},{default:d((()=>[v(t,{class:"context-label"},{default:d((()=>[w("软件位")])),_:1}),v(t,{class:"context-value"},{default:d((()=>[w(y(L.value||"未提供"),1)])),_:1})])),_:1}),v(s,{class:"context-row"},{default:d((()=>[v(t,{class:"context-label"},{default:d((()=>[w("软件码")])),_:1}),v(t,{class:"context-value"},{default:d((()=>[w(y(F.value||"未提供"),1)])),_:1})])),_:1}),P.value?(c(),f(s,{key:0,class:"context-row"},{default:d((()=>[v(t,{class:"context-label"},{default:d((()=>[w("所属代理")])),_:1}),v(t,{class:"context-value"},{default:d((()=>[w(y(P.value),1)])),_:1})])),_:1})):g("",!0),E.value?(c(),f(s,{key:1,class:"context-warning"},{default:d((()=>[w(y(E.value),1)])),_:1})):g("",!0)])),_:1}),v(s,{class:"verify-card glass-card"},{default:d((()=>[v(s,{class:"form"},{default:d((()=>[v(t,{class:"form-label"},{default:d((()=>[w("卡密")])),_:1}),v(l,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=a=>I.value=a),class:"form-input",placeholder:"请输入需要验证的卡密编号","confirm-type":"done"},null,8,["modelValue"]),v(o,{class:"form-submit",disabled:T.value||!$.value,onClick:J},{default:d((()=>[w(y(T.value?"验证中...":"立即验证"),1)])),_:1},8,["disabled"])])),_:1}),j.value?(c(),f(s,{key:0,class:"result"},{default:d((()=>[v(s,{class:p(["status-banner",G.value.statusClass])},{default:d((()=>[v(t,{class:"status-title"},{default:d((()=>[w(y(G.value.title),1)])),_:1}),v(t,{class:"status-message"},{default:d((()=>[w(y(j.value.message),1)])),_:1})])),_:1},8,["class"]),j.value.stats?(c(),f(s,{key:0,class:"stats"},{default:d((()=>[v(s,{class:"stat glass-light"},{default:d((()=>[v(t,{class:"stat-label"},{default:d((()=>[w("验证次数")])),_:1}),v(t,{class:"stat-value"},{default:d((()=>[w(y(j.value.stats.attemptNumber),1)])),_:1})])),_:1}),v(s,{class:"stat glass-light"},{default:d((()=>[v(t,{class:"stat-label"},{default:d((()=>[w("剩余下载")])),_:1}),v(t,{class:"stat-value"},{default:d((()=>[w(y(j.value.stats.remainingDownloads),1)])),_:1})])),_:1}),j.value.stats.expiresAt?(c(),f(s,{key:0,class:"stat glass-light"},{default:d((()=>[v(t,{class:"stat-label"},{default:d((()=>[w("有效期")])),_:1}),v(t,{class:"stat-value"},{default:d((()=>[w(y(j.value.stats.expiresAt),1)])),_:1})])),_:1})):g("",!0)])),_:1})):g("",!0),j.value.downloadUrl?(c(),f(s,{key:1,class:"download"},{default:d((()=>[v(t,{class:"download-label"},{default:d((()=>[w("资源包下载地址")])),_:1}),v(s,{class:"download-row"},{default:d((()=>[v(t,{class:"download-url",onClick:e[1]||(e[1]=a=>R(j.value.downloadUrl))},{default:d((()=>[w(y(j.value.downloadUrl),1)])),_:1}),v(o,{class:"download-btn",onClick:e[2]||(e[2]=a=>R(j.value.downloadUrl))},{default:d((()=>[w("复制链接")])),_:1})])),_:1}),j.value.extractionCode?(c(),f(t,{key:0,class:"download-code"},{default:d((()=>[w("提取码："+y(j.value.extractionCode),1)])),_:1})):g("",!0)])),_:1})):g("",!0),v(s,{class:"history"},{default:d((()=>[v(t,{class:"history-title"},{default:d((()=>[w("下载记录")])),_:1}),j.value.history.length?(c(),f(s,{key:1,class:"history-list"},{default:d((()=>[(c(!0),m(h,null,_(j.value.history,(a=>(c(),f(s,{key:a.id,class:"history-item glass-light"},{default:d((()=>[v(s,{class:"history-row"},{default:d((()=>[v(t,{class:"history-label"},{default:d((()=>[w("链接")])),_:1}),v(t,{class:"history-value"},{default:d((()=>[w(y(a.url),1)])),_:2},1024)])),_:2},1024),v(s,{class:"history-row"},{default:d((()=>[v(t,{class:"history-label"},{default:d((()=>[w("提取码")])),_:1}),v(t,{class:"history-value"},{default:d((()=>[w(y(a.extractionCode||"—"),1)])),_:2},1024)])),_:2},1024),v(s,{class:"history-row"},{default:d((()=>[v(t,{class:"history-label"},{default:d((()=>[w("分配时间")])),_:1}),v(t,{class:"history-value"},{default:d((()=>[w(y(a.assignedAt),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(c(),f(s,{key:0,class:"history-empty"},{default:d((()=>[w("暂无下载记录")])),_:1}))])),_:1})])),_:1})):g("",!0)])),_:1})])),_:1})}}}),[["__scopeId","data-v-e0efd9ea"]]);export{U as default};

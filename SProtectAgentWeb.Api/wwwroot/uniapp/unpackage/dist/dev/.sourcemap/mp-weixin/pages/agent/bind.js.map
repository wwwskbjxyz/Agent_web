{"version":3,"file":"bind.js","sources":["pages/agent/bind.vue","E:/HBuilderX.4.76.2025082103/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvYWdlbnQvYmluZC52dWU"],"sourcesContent":["<template>\r\n  <view class=\"page\">\r\n    <view class=\"glass-card card\">\r\n      <view class=\"header\">\r\n        <text class=\"badge\">绑定软件码</text>\r\n        <text class=\"title\">为当前代理添加作者账号</text>\r\n        <text class=\"subtitle\">输入作者提供的软件码与登录凭证，主控系统将代为安全转发。</text>\r\n      </view>\r\n\r\n      <view class=\"form\">\r\n        <view class=\"form-item\">\r\n          <text class=\"label\">软件码</text>\r\n          <input v-model=\"form.softwareCode\" class=\"input\" placeholder=\"SP-xxxx\" />\r\n        </view>\r\n        <view class=\"form-item\">\r\n          <text class=\"label\">作者账号</text>\r\n          <input v-model=\"form.authorAccount\" class=\"input\" placeholder=\"作者端登录账号\" />\r\n        </view>\r\n        <view class=\"form-item\">\r\n          <text class=\"label\">作者密码</text>\r\n          <input v-model=\"form.authorPassword\" class=\"input\" placeholder=\"作者端登录密码\" password />\r\n        </view>\r\n      </view>\r\n\r\n      <button class=\"submit\" :disabled=\"isSubmitting\" @tap=\"handleBind\">\r\n        {{ isSubmitting ? '绑定中...' : '立即绑定' }}\r\n      </button>\r\n\r\n      <view class=\"list\">\r\n        <view v-if=\"!bindings.length\" class=\"empty\">暂未绑定任何作者，添加后可快速访问对应模块。</view>\r\n        <view v-for=\"item in bindings\" :key=\"item.bindingId\" class=\"binding\">\r\n          <view class=\"binding-info\">\r\n            <text class=\"binding-title\">{{ item.authorDisplayName }}</text>\r\n            <text class=\"binding-sub\">软件码：{{ item.softwareCode }}</text>\r\n            <text class=\"binding-sub\">接口：{{ item.apiAddress }}:{{ item.apiPort }}</text>\r\n          </view>\r\n          <view class=\"binding-actions\">\r\n            <button class=\"binding-btn\" @tap=\"edit(item)\">编辑凭证</button>\r\n            <button class=\"binding-btn\" @tap=\"select(item)\">进入</button>\r\n            <button class=\"binding-btn danger\" :disabled=\"platform.loading.deleteBinding\" @tap=\"remove(item.bindingId)\">\r\n              删除\r\n            </button>\r\n          </view>\r\n        </view>\r\n      </view>\r\n    </view>\r\n    <view v-if=\"showEditor\" class=\"editor-mask\" @tap.self=\"closeEditor\">\r\n      <view class=\"glass-card editor-card\">\r\n        <view class=\"editor-header\">\r\n          <text class=\"editor-title\">修改作者凭证</text>\r\n          <text class=\"editor-sub\">更新后将用于转发登录</text>\r\n        </view>\r\n        <view class=\"form\">\r\n          <view class=\"form-item\">\r\n            <text class=\"label\">作者账号</text>\r\n            <input v-model=\"editor.authorAccount\" class=\"input\" placeholder=\"作者端登录账号\" />\r\n          </view>\r\n          <view class=\"form-item\">\r\n            <text class=\"label\">作者密码</text>\r\n            <input v-model=\"editor.authorPassword\" class=\"input\" placeholder=\"作者端登录密码\" password />\r\n          </view>\r\n        </view>\r\n        <view class=\"editor-actions\">\r\n          <button class=\"binding-btn ghost\" @tap=\"closeEditor\">取消</button>\r\n          <button class=\"binding-btn\" :disabled=\"editorLoading\" @tap=\"submitEdit\">\r\n            {{ editorLoading ? '保存中...' : '保存修改' }}\r\n          </button>\r\n        </view>\r\n      </view>\r\n    </view>\r\n  </view>\r\n</template>\r\n\r\n<script setup lang=\"ts\">\r\nimport { computed, onMounted, reactive, ref } from 'vue';\r\nimport { usePlatformStore } from '@/stores/platform';\r\nimport { useAppStore } from '@/stores/app';\r\n\r\nconst platform = usePlatformStore();\r\nconst appStore = useAppStore();\r\nconst form = reactive({\r\n  softwareCode: '',\r\n  authorAccount: '',\r\n  authorPassword: ''\r\n});\r\n\r\nconst isSubmitting = computed(() => platform.loading.createBinding);\r\nconst bindings = computed(() => platform.bindings);\r\nconst editorLoading = computed(() => platform.loading.updateBinding);\r\nconst showEditor = ref(false);\r\nconst editor = reactive({\r\n  bindingId: 0,\r\n  authorAccount: '',\r\n  authorPassword: ''\r\n});\r\n\r\nasync function loginWithBinding(binding: (typeof platform.bindings)[number], options?: { silent?: boolean }) {\r\n  if (!binding.authorAccount || !binding.authorPassword) {\r\n    return;\r\n  }\r\n  try {\r\n    await appStore.login(\r\n      { username: binding.authorAccount, password: binding.authorPassword },\r\n      { skipBootstrap: false }\r\n    );\r\n  } catch (error) {\r\n    if (!options?.silent) {\r\n      const message =\r\n        (error as any)?.message && typeof (error as any).message === 'string'\r\n          ? (error as any).message\r\n          : '自动登录作者端失败，请稍后重试';\r\n      uni.showToast({ title: message, icon: 'none' });\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\nonMounted(async () => {\r\n  if (!platform.isAuthenticated) {\r\n    uni.reLaunch({ url: '/pages/login/agent' });\r\n    return;\r\n  }\r\n\r\n  if (!platform.bindings.length) {\r\n    await platform.fetchAgentProfile();\r\n  }\r\n});\r\n\r\nasync function handleBind() {\r\n  if (!form.softwareCode || !form.authorAccount || !form.authorPassword) {\r\n    uni.showToast({ title: '请完整填写信息', icon: 'none' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    const result = await platform.createBinding({ ...form });\r\n    uni.showToast({ title: '绑定成功', icon: 'success' });\r\n    platform.selectBinding(result);\r\n    try {\r\n      await loginWithBinding(result, { silent: true });\r\n    } catch (error) {\r\n      uni.__f__('warn','at pages/agent/bind.vue:142','登录作者端失败', error);\r\n    }\r\n    form.softwareCode = '';\r\n    form.authorAccount = '';\r\n    form.authorPassword = '';\r\n  } catch (error) {\r\n    const message =\r\n      (error as any)?.message && typeof (error as any).message === 'string'\r\n        ? (error as any).message\r\n        : '绑定失败，请检查软件码';\r\n    uni.showToast({ title: message, icon: 'none' });\r\n  }\r\n}\r\n\r\nfunction select(item: (typeof platform.bindings)[number]) {\r\n  platform.selectBinding(item);\r\n  loginWithBinding(item, { silent: true })\r\n    .then(() => {\r\n      uni.showToast({ title: '已切换到 ' + item.softwareCode, icon: 'success' });\r\n      uni.reLaunch({ url: '/pages/index/index' });\r\n    })\r\n    .catch(() => {\r\n      uni.reLaunch({ url: '/pages/index/index' });\r\n    });\r\n}\r\n\r\nfunction edit(item: (typeof platform.bindings)[number]) {\r\n  editor.bindingId = item.bindingId;\r\n  editor.authorAccount = item.authorAccount;\r\n  editor.authorPassword = item.authorPassword;\r\n  showEditor.value = true;\r\n}\r\n\r\nfunction closeEditor() {\r\n  showEditor.value = false;\r\n}\r\n\r\nasync function submitEdit() {\r\n  if (!editor.authorAccount || !editor.authorPassword) {\r\n    uni.showToast({ title: '请输入完整信息', icon: 'none' });\r\n    return;\r\n  }\r\n\r\n  const target = bindings.value.find((item) => item.bindingId === editor.bindingId);\r\n  if (!target) {\r\n    uni.showToast({ title: '未找到绑定记录', icon: 'none' });\r\n    return;\r\n  }\r\n\r\n  try {\r\n    await platform.updateBinding(editor.bindingId, {\r\n      softwareCode: target.softwareCode,\r\n      authorAccount: editor.authorAccount.trim(),\r\n      authorPassword: editor.authorPassword\r\n    });\r\n    uni.showToast({ title: '已更新', icon: 'success' });\r\n    closeEditor();\r\n  } catch (error) {\r\n    const message =\r\n      (error as any)?.message && typeof (error as any).message === 'string'\r\n        ? (error as any).message\r\n        : '更新失败，请稍后重试';\r\n    uni.showToast({ title: message, icon: 'none' });\r\n  }\r\n}\r\n\r\nasync function remove(bindingId: number) {\r\n  uni.showModal({\r\n    title: '确认删除',\r\n    content: '删除后将无法通过主控访问该作者接口，确定删除吗？',\r\n    success: async (res) => {\r\n      if (!res.confirm) return;\r\n      await platform.deleteBinding(bindingId);\r\n      uni.showToast({ title: '已删除', icon: 'success' });\r\n    }\r\n  });\r\n}\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n.page {\r\n  min-height: 100vh;\r\n  padding: 60rpx 32rpx;\r\n  display: flex;\r\n  align-items: flex-start;\r\n  justify-content: center;\r\n}\r\n\r\n.card {\r\n  width: min(820rpx, 100%);\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 32rpx;\r\n  padding: 40rpx 36rpx;\r\n}\r\n\r\n.header {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 16rpx;\r\n}\r\n\r\n.badge {\r\n  align-self: flex-start;\r\n  padding: 10rpx 26rpx;\r\n  border-radius: 999rpx;\r\n  background: rgba(96, 165, 250, 0.18);\r\n  color: rgba(125, 211, 252, 0.95);\r\n  font-size: 22rpx;\r\n  letter-spacing: 0.08em;\r\n}\r\n\r\n.title {\r\n  font-size: 42rpx;\r\n  font-weight: 600;\r\n  color: #f8fafc;\r\n}\r\n\r\n.subtitle {\r\n  font-size: 24rpx;\r\n  color: rgba(226, 232, 240, 0.75);\r\n  line-height: 1.6;\r\n}\r\n\r\n.form {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 20rpx;\r\n}\r\n\r\n.form-item {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 12rpx;\r\n}\r\n\r\n.label {\r\n  font-size: 24rpx;\r\n  color: rgba(148, 163, 184, 0.85);\r\n}\r\n\r\n.input {\r\n  padding: 18rpx 24rpx;\r\n  border-radius: 16rpx;\r\n  background: rgba(15, 23, 42, 0.55);\r\n  border: 1px solid rgba(148, 163, 184, 0.2);\r\n  color: #e2e8f0;\r\n  font-size: 26rpx;\r\n}\r\n\r\n.submit {\r\n  padding: 22rpx 0;\r\n  border-radius: 16rpx;\r\n  background: linear-gradient(135deg, #22d3ee, #6366f1);\r\n  color: #fff;\r\n  font-size: 28rpx;\r\n  font-weight: 600;\r\n  border: none;\r\n}\r\n\r\n.list {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 20rpx;\r\n}\r\n\r\n.editor-mask {\r\n  position: fixed;\r\n  inset: 0;\r\n  background: rgba(15, 23, 42, 0.65);\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 40rpx 32rpx;\r\n  z-index: 99;\r\n}\r\n\r\n.editor-card {\r\n  width: min(720rpx, 100%);\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 24rpx;\r\n  padding: 36rpx 32rpx;\r\n}\r\n\r\n.editor-header {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8rpx;\r\n}\r\n\r\n.editor-title {\r\n  font-size: 34rpx;\r\n  font-weight: 600;\r\n  color: #f8fafc;\r\n}\r\n\r\n.editor-sub {\r\n  font-size: 24rpx;\r\n  color: rgba(148, 163, 184, 0.75);\r\n}\r\n\r\n.editor-actions {\r\n  display: flex;\r\n  gap: 20rpx;\r\n  justify-content: flex-end;\r\n}\r\n\r\n.binding-btn.ghost {\r\n  background: rgba(148, 163, 184, 0.18);\r\n  color: rgba(226, 232, 240, 0.9);\r\n}\r\n\r\n.empty {\r\n  padding: 28rpx;\r\n  border-radius: 16rpx;\r\n  background: rgba(15, 23, 42, 0.45);\r\n  color: rgba(148, 163, 184, 0.9);\r\n  font-size: 24rpx;\r\n  text-align: center;\r\n}\r\n\r\n.binding {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 20rpx;\r\n  padding: 24rpx;\r\n  border-radius: 18rpx;\r\n  background: rgba(15, 23, 42, 0.55);\r\n  border: 1px solid rgba(148, 163, 184, 0.18);\r\n}\r\n\r\n.binding-info {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8rpx;\r\n}\r\n\r\n.binding-title {\r\n  font-size: 30rpx;\r\n  color: #f8fafc;\r\n  font-weight: 600;\r\n}\r\n\r\n.binding-sub {\r\n  font-size: 24rpx;\r\n  color: rgba(148, 163, 184, 0.8);\r\n}\r\n\r\n.binding-actions {\r\n  display: grid;\r\n  grid-template-columns: repeat(3, minmax(0, 1fr));\r\n  gap: 12rpx;\r\n  width: 100%;\r\n}\r\n\r\n.binding-btn {\r\n  display: inline-flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  padding: 16rpx 0;\r\n  border-radius: 14rpx;\r\n  border: none;\r\n  font-size: 24rpx;\r\n  font-weight: 600;\r\n  background: rgba(59, 130, 246, 0.22);\r\n  color: rgba(191, 219, 254, 0.95);\r\n  width: 100%;\r\n}\r\n\r\n.binding-btn.danger {\r\n  background: rgba(239, 68, 68, 0.2);\r\n  color: rgba(248, 113, 113, 0.95);\r\n}\r\n</style>\r\n","import MiniProgramPage from 'C:/Users/Administrator/source/repos/wwwskbjxyz/SPTEST-V1/SProtectAgentWeb.Api/wwwroot/uniapp/pages/agent/bind.vue'\nwx.createPage(MiniProgramPage)"],"names":["usePlatformStore","useAppStore","reactive","computed","ref","uni","onMounted"],"mappings":"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"}
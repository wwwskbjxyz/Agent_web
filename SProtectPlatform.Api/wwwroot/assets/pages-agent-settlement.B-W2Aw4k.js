import{d as e,D as l,u as a,x as t,r as s,g as u,h as n,y as i,z as c,o as d,c as r,w as o,A as f,a as v,b as m,t as b,k as _,j as y,l as p,B as g,F as w,s as h,m as k,i as S,f as N,e as T,v as A,I as V,S as $,_ as U}from"./index-fvgcSFN3.js";const F=U(e({__name:"settlement",setup(e){const U=l(),F=a(),{selectedSoftware:M,cardTypes:D,selectedSettlementAgent:x,settlementAgents:C,activeSettlementAgent:B,settlementCycle:H,settlementBills:E,settlementHasReminder:I}=t(U),R=s([]),j=s(""),L=s(""),O=u({}),z=u({}),Y=n((()=>U.loading.settlementRates)),q=n((()=>U.loading.cardTypes)),G=n((()=>U.loading.saveSettlementRates)),J=n((()=>{var e;const l=(Array.isArray(C.value)?C.value:[]).map((e=>({value:((null==e?void 0:e.username)??"").toString().trim(),label:((null==e?void 0:e.displayName)??"").toString().trim()||((null==e?void 0:e.username)??"").toString().trim()}))).filter((e=>e.value.length>0));if(!l.length){const a=null==(e=B.value)?void 0:e.trim();a&&l.push({value:a,label:`${a} · 当前账号`})}return l})),K=n((()=>J.value.length>0)),P=n((()=>{var e,l;return(null==(e=x.value)?void 0:e.trim())||(null==(l=B.value)?void 0:l.trim())||""})),Q=n((()=>{const e=J.value,l=P.value,a=e.findIndex((e=>e.value===l));return a>=0?a:0})),W=n((()=>{var e;const l=J.value,a=P.value,t=l.find((e=>e.value===a));return(null==t?void 0:t.label)||(null==(e=l[0])?void 0:e.label)||"当前账号"})),X=n((()=>H.value)),Z=n((()=>{var e;return Boolean(null==(e=X.value)?void 0:e.isDue)})),ee=n((()=>{var e;return(null==(e=X.value)?void 0:e.effectiveDays)??0})),le=n((()=>{var e;return Boolean(null==(e=X.value)?void 0:e.isInherited)})),ae=n((()=>{var e;return ve(null==(e=X.value)?void 0:e.nextDueTimeUtc)})),te=n((()=>{var e;return ve(null==(e=X.value)?void 0:e.lastSettledTimeUtc)})),se=n((()=>{var e;return(null==(e=X.value)?void 0:e.effectiveTimeLabel)||me(0)})),ue=n((()=>{const e=X.value;if(!e)return"HH:mm";return Number.isInteger(e.ownTimeMinutes)&&(e.ownDays>0||e.ownTimeMinutes!==e.effectiveTimeMinutes)?e.ownTimeLabel||me(e.ownTimeMinutes):`默认 ${e.effectiveTimeLabel||me(e.effectiveTimeMinutes)}`})),ne=n((()=>E.value.filter((e=>!e.isSettled)))),ie=n((()=>E.value.filter((e=>e.isSettled))));function ce(e){return Array.isArray(null==e?void 0:e.breakdowns)&&e.breakdowns.length>0}i(J,(async e=>{if(!e.length)return;const l=P.value;if(!e.some((e=>e.value===l))){const l=e[0];l&&(U.setSelectedSettlementAgent(l.value),await oe(!0))}}),{immediate:!1}),i(H,(e=>{if(!e)return j.value="",void(L.value="");const l=e.ownDays>0?e.ownDays:e.effectiveDays;j.value=l>0?String(l):"";const a=e.ownDays>0||e.ownTimeMinutes!==e.effectiveTimeMinutes?e.ownTimeMinutes:e.effectiveTimeMinutes;Number.isFinite(a)?L.value=me(Number(a)):L.value=""}),{immediate:!0}),i(ne,(e=>{const l=new Set;e.forEach((e=>{l.add(e.id);const a=function(e){if(null==e)return"";const l=Number(e);if(!Number.isFinite(l)||l<=0)return"";return fe(l)}(e.suggestedAmount??e.amount);O[e.id]&&"0"!==O[e.id]&&"0.00"!==O[e.id]||(O[e.id]=a),e.note&&!z[e.id]&&(z[e.id]=e.note)})),Object.keys(O).forEach((e=>{const a=Number(e);Number.isFinite(a)&&l.has(a)||delete O[a]})),Object.keys(z).forEach((e=>{const a=Number(e);Number.isFinite(a)&&l.has(a)||delete z[a]}))}),{immediate:!0});let de=0;function re(e,l){const a=new Set;return e.forEach((e=>{(null==e?void 0:e.cardType)&&a.add(e.cardType)})),Array.isArray(l)&&l.forEach((e=>{(null==e?void 0:e.name)&&a.add(e.name)})),Array.from(a).sort(((e,l)=>e.localeCompare(l))).map((l=>{const a=e.find((e=>e.cardType===l));return{cardType:l,price:a?fe(a.price):"0.00"}}))}async function oe(e=!1){if(M.value)try{const l=++de,a=U.loadCardTypes(e).catch((e=>(console.warn("loadCardTypes failed",e),null))),t=await U.loadSettlementRates(e),s=Array.isArray(t)?t:[];R.value=re(s,D.value),a.then((e=>{if(l!==de)return;const a=Array.isArray(e)&&e.length>0?e:D.value;R.value=re(s,a)}))}catch(l){console.error("refresh settlement rates failed",l),h({title:"加载失败",icon:"none"})}else R.value=[]}function fe(e){const l=Number(e??0);return Number.isFinite(l)?l.toFixed(2):"0.00"}function ve(e){if(!e)return"--";const l=new Date(e);if(Number.isNaN(l.getTime()))return e;return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")} ${String(l.getHours()).padStart(2,"0")}:${String(l.getMinutes()).padStart(2,"0")}`}function me(e){const l=Number(e);if(!Number.isFinite(l))return"00:00";const a=(l%1440+1440)%1440,t=Math.floor(a/60),s=Math.floor(a%60);return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}function be(){const e=j.value.trim();if(!e)return null;const l=Number(e);return!Number.isFinite(l)||l<=0?0:Math.floor(l)}function _e(){const e=be();j.value=null===e||e<=0?"":String(e)}function ye(){const e=L.value.trim();if(!e)return null;const l=e.replace("：",":").match(/^\s*(\d{1,2})\s*:\s*(\d{1,2})\s*$/);if(!l)return;const a=Number(l[1]),t=Number(l[2]);return!Number.isFinite(a)||!Number.isFinite(t)||a<0||a>23||t<0||t>59?void 0:60*a+t}function pe(){const e=ye();if(void 0===e)return L.value="",void h({title:"时间格式应为 HH:mm",icon:"none"});L.value=null!==e?me(e):""}async function ge(){if(!M.value)return void h({title:"请先选择软件位",icon:"none"});const e=R.value.map((e=>({cardType:e.cardType,price:Number(e.price)||0})));try{const l=be(),a=ye();if(void 0===a)return void h({title:"请填写正确的结算时间（HH:mm）",icon:"none"});await U.saveSettlementRates(e,l??void 0,a??void 0),h({title:"保存成功",icon:"success"}),await oe(!0)}catch(l){console.error("save settlement rates failed",l);const e=(null==l?void 0:l.message)||"保存失败";h({title:e,icon:"none"})}}async function we(e){var l;const a=Number((null==(l=null==e?void 0:e.detail)?void 0:l.value)??0),t=J.value[a];t&&(U.setSelectedSettlementAgent(t.value),await oe(!0))}function he(){k({url:"/pages/login/agent"})}return i((()=>M.value),(()=>{oe()})),c((()=>{!async function(){F.isAuthenticated&&await oe(!0)}()})),(e,l)=>{const a=S,t=N,s=T,u=A,n=V,i=$;return d(),r(s,{class:"page"},{default:o((()=>[f(F).isAuthenticated?(d(),r(i,{key:1,"scroll-y":"",class:"content"},{default:o((()=>[v(s,{class:"section"},{default:o((()=>[v(s,{class:"section-header"},{default:o((()=>[v(s,{class:"section-titles"},{default:o((()=>[v(a,{class:"section-title"},{default:o((()=>[m("结算设置")])),_:1}),v(a,{class:"section-subtitle"},{default:o((()=>[m("为不同卡密类型配置结算价格，销量查询将自动计算总额。")])),_:1})])),_:1}),v(s,{class:"section-meta"},{default:o((()=>[v(a,{class:"meta-label"},{default:o((()=>[m("当前软件位")])),_:1}),v(a,{class:"meta-value"},{default:o((()=>[m(b(f(M)||"未选择"),1)])),_:1})])),_:1})])),_:1}),f(M)?(d(),r(s,{key:1},{default:o((()=>[Y.value?(d(),r(s,{key:0,class:"section-empty"},{default:o((()=>[m("结算信息加载中...")])),_:1})):R.value.length?(d(),r(s,{key:2},{default:o((()=>[q.value?(d(),r(s,{key:0,class:"section-note"},{default:o((()=>[m("卡密类型同步中，稍后将自动补齐列表。")])),_:1})):_("",!0),K.value?(d(),r(s,{key:1,class:"agent-selector"},{default:o((()=>[v(s,{class:"selector-labels"},{default:o((()=>[v(a,{class:"selector-title"},{default:o((()=>[m("配置对象")])),_:1}),v(a,{class:"selector-hint"},{default:o((()=>[m("为不同代理设置专属结算单价")])),_:1})])),_:1}),v(u,{mode:"selector",range:J.value,"range-key":"label",value:Q.value,disabled:Y.value,onChange:we},{default:o((()=>[v(s,{class:y(["selector-value",{disabled:Y.value}])},{default:o((()=>[v(a,{class:"selector-text"},{default:o((()=>[m(b(W.value),1)])),_:1}),v(a,{class:"selector-arrow"},{default:o((()=>[m("⌄")])),_:1})])),_:1},8,["class"])])),_:1},8,["range","value","disabled"])])),_:1})):_("",!0),v(s,{class:"cycle-box"},{default:o((()=>[v(s,{class:"cycle-header"},{default:o((()=>[v(s,{class:"cycle-title-group"},{default:o((()=>[v(a,{class:"cycle-title"},{default:o((()=>[m("结算周期")])),_:1}),le.value?(d(),r(a,{key:0,class:"cycle-badge"},{default:o((()=>[m("继承")])),_:1})):_("",!0)])),_:1}),v(s,{class:y(["cycle-status",{due:Z.value}])},{default:o((()=>[v(a,{class:"status-label"},{default:o((()=>[m("下次结算")])),_:1}),v(a,{class:"status-value"},{default:o((()=>[m(b(ae.value),1)])),_:1})])),_:1},8,["class"])])),_:1}),v(s,{class:"cycle-body"},{default:o((()=>[v(s,{class:"cycle-input"},{default:o((()=>[v(n,{class:"cycle-field",type:"digit",placeholder:ee.value>0?`默认 ${ee.value} 天`:"输入天数",modelValue:j.value,"onUpdate:modelValue":l[0]||(l[0]=e=>j.value=e),disabled:G.value,onBlur:_e},null,8,["placeholder","modelValue","disabled"]),v(a,{class:"cycle-unit"},{default:o((()=>[m("天")])),_:1})])),_:1}),v(s,{class:"cycle-input"},{default:o((()=>[v(n,{class:"cycle-field",type:"text",placeholder:ue.value,modelValue:L.value,"onUpdate:modelValue":l[1]||(l[1]=e=>L.value=e),disabled:G.value,onBlur:pe},null,8,["placeholder","modelValue","disabled"]),v(a,{class:"cycle-unit"},{default:o((()=>[m("时间")])),_:1})])),_:1}),v(s,{class:"cycle-meta"},{default:o((()=>[v(a,{class:"meta-label"},{default:o((()=>[m("最近结算")])),_:1}),v(a,{class:"meta-value"},{default:o((()=>[m(b(te.value),1)])),_:1})])),_:1}),v(s,{class:"cycle-meta"},{default:o((()=>[v(a,{class:"meta-label"},{default:o((()=>[m("执行时间")])),_:1}),v(a,{class:"meta-value"},{default:o((()=>[m(b(se.value),1)])),_:1})])),_:1}),Z.value?(d(),r(s,{key:0,class:"cycle-meta"},{default:o((()=>[v(a,{class:"meta-label warn"},{default:o((()=>[m("提醒")])),_:1}),v(a,{class:"meta-value warn"},{default:o((()=>[m("当前周期已到，请及时完成结算。")])),_:1})])),_:1})):_("",!0)])),_:1})])),_:1}),v(s,{class:"rate-table"},{default:o((()=>[v(s,{class:"rate-header"},{default:o((()=>[v(a,{class:"col-type"},{default:o((()=>[m("卡密类型")])),_:1}),v(a,{class:"col-price"},{default:o((()=>[m("结算单价（元）")])),_:1})])),_:1}),(d(!0),p(w,null,g(R.value,(e=>(d(),r(s,{key:e.cardType,class:"rate-row"},{default:o((()=>[v(a,{class:"col-type"},{default:o((()=>[m(b(e.cardType),1)])),_:2},1024),v(n,{class:"col-price-input",type:"digit",placeholder:"0.00",modelValue:e.price,"onUpdate:modelValue":l=>e.price=l,onBlur:l=>function(e){e.price=fe(e.price)}(e)},null,8,["modelValue","onUpdate:modelValue","onBlur"])])),_:2},1024)))),128))])),_:1})])),_:1})):(d(),r(s,{key:1,class:"section-empty"},{default:o((()=>[m("当前软件位暂无卡密类型。")])),_:1})),v(s,{class:"actions"},{default:o((()=>[v(t,{class:"btn primary",disabled:G.value||Y.value||q.value,onClick:ge},{default:o((()=>[m(b(G.value?"保存中...":"保存设置"),1)])),_:1},8,["disabled"]),v(t,{class:"btn ghost",disabled:G.value||Y.value,onClick:oe},{default:o((()=>[m("重新加载")])),_:1},8,["disabled"])])),_:1})])),_:1})):(d(),r(s,{key:0,class:"section-empty"},{default:o((()=>[m("请返回首页选择一个软件码后再进行设置。")])),_:1}))])),_:1}),v(s,{class:"section"},{default:o((()=>[v(s,{class:"section-header"},{default:o((()=>[v(s,{class:"section-titles"},{default:o((()=>[v(a,{class:"section-title"},{default:o((()=>[m("结算账单")])),_:1}),v(a,{class:"section-subtitle"},{default:o((()=>[m("系统会根据结算周期生成待处理账单，确认收款后请标记已结算。")])),_:1})])),_:1})])),_:1}),ne.value.length||ie.value.length?(d(),r(s,{key:1,class:"bill-list"},{default:o((()=>[(d(!0),p(w,null,g(ne.value,(e=>(d(),r(s,{key:`pending-${e.id}`,class:"bill-card pending"},{default:o((()=>[v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算周期")])),_:1}),v(a,{class:"bill-value"},{default:o((()=>[m(b(ve(e.cycleStartUtc))+" ~ "+b(ve(e.cycleEndUtc)),1)])),_:2},1024)])),_:2},1024),ce(e)?(d(),r(s,{key:0,class:"bill-breakdown"},{default:o((()=>[v(s,{class:"breakdown-header"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算明细")])),_:1}),v(a,{class:"bill-subtotal"},{default:o((()=>[m("建议金额：￥"+b(fe(e.suggestedAmount??e.amount)),1)])),_:2},1024)])),_:2},1024),(d(!0),p(w,null,g(e.breakdowns,(l=>(d(),r(s,{key:`${e.id}-${l.agent}`,class:"breakdown-row"},{default:o((()=>[v(a,{class:"breakdown-agent"},{default:o((()=>[m(b(l.displayName||l.agent),1)])),_:2},1024),v(a,{class:"breakdown-count"},{default:o((()=>[m(b(l.count)+" 张",1)])),_:2},1024),v(a,{class:"breakdown-amount"},{default:o((()=>[m("￥"+b(fe(l.amount)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):(d(),r(s,{key:1,class:"bill-row subtle"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算明细")])),_:1}),v(a,{class:"bill-value"},{default:o((()=>[m("当前周期无待结算数据")])),_:1})])),_:1})),v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算金额")])),_:1}),v(n,{class:"bill-input",type:"digit",modelValue:O[e.id],"onUpdate:modelValue":l=>O[e.id]=l,placeholder:e.suggestedAmount?fe(e.suggestedAmount):"0.00",disabled:!ce(e)},null,8,["modelValue","onUpdate:modelValue","placeholder","disabled"])])),_:2},1024),v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("备注")])),_:1}),v(n,{class:"bill-input",type:"text",modelValue:z[e.id],"onUpdate:modelValue":l=>z[e.id]=l,placeholder:"备注信息（可选）"},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1024),v(t,{class:"btn primary",disabled:G.value||!ce(e),onClick:l=>async function(e){const l=O[e]??"0";let a=Number(l);const t=ne.value.find((l=>l.id===e));if((!Number.isFinite(a)||a<=0)&&t&&Number(t.suggestedAmount??0)>0&&(a=Number(t.suggestedAmount)),!Number.isFinite(a)||a<0)h({title:"请输入有效金额",icon:"none"});else try{await U.completeSettlementBill(e,a,z[e]),delete O[e],delete z[e],h({title:"账单已结算",icon:"success"})}catch(s){console.error("complete settlement bill failed",s);const e=(null==s?void 0:s.message)||"更新失败";h({title:e,icon:"none"})}}(e.id)},{default:o((()=>[m("确认已结算")])),_:2},1032,["disabled","onClick"])])),_:2},1024)))),128)),(d(!0),p(w,null,g(ie.value,(e=>(d(),r(s,{key:`settled-${e.id}`,class:"bill-card settled"},{default:o((()=>{var l;return[v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算周期")])),_:1}),v(a,{class:"bill-value"},{default:o((()=>[m(b(ve(e.cycleStartUtc))+" ~ "+b(ve(e.cycleEndUtc)),1)])),_:2},1024)])),_:2},1024),v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算金额")])),_:1}),v(a,{class:"bill-value emphasis"},{default:o((()=>[m("￥"+b(fe(e.amount)),1)])),_:2},1024)])),_:2},1024),(null==(l=e.breakdowns)?void 0:l.length)?(d(),r(s,{key:0,class:"bill-breakdown settled"},{default:o((()=>[v(s,{class:"breakdown-header"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算明细")])),_:1})])),_:1}),(d(!0),p(w,null,g(e.breakdowns,(l=>(d(),r(s,{key:`${e.id}-${l.agent}`,class:"breakdown-row"},{default:o((()=>[v(a,{class:"breakdown-agent"},{default:o((()=>[m(b(l.displayName||l.agent),1)])),_:2},1024),v(a,{class:"breakdown-count"},{default:o((()=>[m(b(l.count)+" 张",1)])),_:2},1024),v(a,{class:"breakdown-amount"},{default:o((()=>[m("￥"+b(fe(l.amount)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:2},1024)):_("",!0),v(s,{class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("结算时间")])),_:1}),v(a,{class:"bill-value"},{default:o((()=>[m(b(ve(e.settledAtUtc)),1)])),_:2},1024)])),_:2},1024),e.note?(d(),r(s,{key:1,class:"bill-row"},{default:o((()=>[v(a,{class:"bill-label"},{default:o((()=>[m("备注")])),_:1}),v(a,{class:"bill-value"},{default:o((()=>[m(b(e.note),1)])),_:2},1024)])),_:2},1024)):_("",!0)]})),_:2},1024)))),128))])),_:1})):(d(),r(s,{key:0,class:"section-empty"},{default:o((()=>[m("暂无结算账单。")])),_:1}))])),_:1}),v(s,{class:"tips"},{default:o((()=>[v(a,null,{default:o((()=>[m("提示：")])),_:1}),v(a,null,{default:o((()=>[m("1. 结算价格仅用于前端统计，不会影响卡密本身价格。")])),_:1}),v(a,null,{default:o((()=>[m("2. 修改后请重新在首页执行销量查询以刷新结算金额。")])),_:1})])),_:1})])),_:1})):(d(),r(s,{key:0,class:"empty"},{default:o((()=>[v(a,null,{default:o((()=>[m("请先登录代理账号后再管理结算设置。")])),_:1}),v(t,{class:"link",onClick:he},{default:o((()=>[m("前往登录")])),_:1})])),_:1}))])),_:1})}}}),[["__scopeId","data-v-e7606f5a"]]);export{F as default};

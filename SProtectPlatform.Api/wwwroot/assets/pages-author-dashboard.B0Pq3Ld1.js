import{d as e,u as a,x as t,h as l,r as s,y as o,g as i,z as n,m as u,s as d,o as r,c,w as f,a as p,b as v,A as m,t as h,l as w,k as g,F as y,B as _,C as A,p as k,i as b,f as I,e as C,v as P,I as N,S,j as T,_ as V}from"./index-fvgcSFN3.js";const B=V(e({__name:"dashboard",setup(e){const V=a(),{authorWeChatBinding:B,authorWechatSubscriptions:W,wechatTemplates:x,wechatTemplatePreviews:U}=t(V),$=l((()=>V.authorProfile)),j=l((()=>{var e;return(null==(e=$.value)?void 0:e.softwares)??[]})),Q=l({get:()=>V.selectedAuthorSoftwareId,set:e=>V.selectAuthorSoftware(e)}),z=l((()=>{if(!j.value.length)return null;return j.value.find((e=>e.softwareId===Q.value))??j.value[0]??null})),E=s(!1),F=l((()=>Boolean(B.value))),M=l((()=>V.loading.wechatBinding||V.loading.wechatBind||V.loading.wechatUnbind)),O=l((()=>{var e,a,t,l,s,o;const i=x.value;if(!i)return[];return[{key:"instant",title:"即时沟通提醒",description:"代理或客户有新留言时提醒",templateId:(null==(e=i.instantCommunication)?void 0:e.trim())??"",preview:(null==(a=U.value)?void 0:a.instant)??null},{key:"blacklist",title:"黑名单严重警告",description:"黑名单触发时快速通知",templateId:(null==(t=i.blacklistAlert)?void 0:t.trim())??"",preview:(null==(l=U.value)?void 0:l.blacklist)??null},{key:"settlement",title:"结算账单通知",description:"结算周期到期时提醒处理账单",templateId:(null==(s=i.settlementNotice)?void 0:s.trim())??"",preview:(null==(o=U.value)?void 0:o.settlement)??null}].filter((e=>e.templateId.length>=10&&!e.templateId.includes("...")))})),q=l((()=>W.value??{}));l((()=>F.value&&O.value.length>0)),l((()=>{var e;const a=B.value;if(!a)return"";const t=null==(e=a.nickname)?void 0:e.trim();return t||((l=a.openId)?l.length<=6?l:`${l.slice(0,4)}***${l.slice(-3)}`:"");var l})),l((()=>M.value?"处理中...":F.value?"重新绑定":"绑定微信")),l((()=>E.value?M.value&&!B.value?"加载中...":F.value?"已绑定":"未绑定":"仅微信小程序支持")),s(!1),o((()=>{var e;return[(null==(e=B.value)?void 0:e.openId)??null,O.value.length]}),(()=>{!function(){if(!F.value||!O.value.length)return;const e=q.value;e&&Object.keys(e).length>0||O.value.forEach((e=>{V.setAuthorWechatSubscription(e.key,!0)}))}()}),{immediate:!0});const D=s(!1),G=i({softwareId:0,displayName:"",apiAddress:"",apiPort:8080,softwareType:"SP"}),H=[{value:"SP",label:"SProtect (默认)"},{value:"QP",label:"QProtect"},{value:"API",label:"自定义 API"}],J=l((()=>H.find((e=>e.value===G.softwareType))??H[0])),K=l((()=>V.loading.updateAuthor||V.loading.updateAuthorSoftware||V.loading.createAuthorSoftware));function L(e){const a=Number(e.detail.value??0),t=H[a]??H[0];G.softwareType=t.value}function R(e){const a=Number(e.detail.value??0),t=j.value[a];t&&(D.value=!1,V.selectAuthorSoftware(t.softwareId))}function X(e){e&&A({data:e,success:()=>{d({title:"软件码已复制",icon:"none"})},fail:()=>{d({title:"复制失败",icon:"none"})}})}function Y(e){D.value=!1,V.selectAuthorSoftware(e.softwareId)}function Z(e){const a=H.find((a=>a.value===e));return(null==a?void 0:a.label)??e}function ee(){D.value=!0,G.softwareId=0,G.displayName="",G.apiAddress="",G.apiPort=8080,G.softwareType="SP"}function ae(){D.value=!1,z.value&&(G.softwareId=z.value.softwareId,G.displayName=z.value.displayName,G.apiAddress=z.value.apiAddress,G.apiPort=z.value.apiPort,G.softwareType=z.value.softwareType)}async function te(){if(G.displayName&&G.apiAddress)try{if(D.value){const e=await V.createAuthorSoftware({displayName:G.displayName.trim(),apiAddress:G.apiAddress.trim(),apiPort:G.apiPort,softwareType:G.softwareType});D.value=!1,d({title:`已新增：${e.softwareCode}`,icon:"none"})}else G.softwareId&&(await V.updateAuthorSoftware(G.softwareId,{displayName:G.displayName.trim(),apiAddress:G.apiAddress.trim(),apiPort:G.apiPort,softwareType:G.softwareType}),d({title:"已保存",icon:"success"}))}catch(e){const a=(null==e?void 0:e.message)&&"string"==typeof e.message?e.message:"操作失败，请稍后重试";d({title:a,icon:"none"})}else d({title:"请完善信息",icon:"none"})}async function le(){if(z.value)try{const e=await V.regenerateAuthorCode(z.value.softwareId);d({title:`新软件码：${e}`,icon:"none"}),await V.fetchAuthorProfile()}catch(e){const a=(null==e?void 0:e.message)&&"string"==typeof e.message?e.message:"生成失败，请稍后重试";d({title:a,icon:"none"})}}function se(){V.logoutAuthor(),u({url:"/pages/login/author"})}function oe(){k({title:"确认注销作者账号",content:"该操作不可恢复，确认继续？",success:async e=>{if(e.confirm)try{await V.deleteAuthorAccount(),d({title:"账号已注销",icon:"none"}),u({url:"/pages/login/author"})}catch(a){const e=(null==a?void 0:a.message)&&"string"==typeof a.message?a.message:"操作失败，请稍后重试";d({title:e,icon:"none"})}}})}function ie(){!z.value||j.value.length<=1||k({title:"确认删除软件码",content:"删除后代理无法再使用此软件码，是否继续？",success:async e=>{if(e.confirm&&z.value)try{await V.deleteAuthorSoftware(z.value.softwareId),d({title:"已删除",icon:"success"})}catch(a){const e=(null==a?void 0:a.message)&&"string"==typeof a.message?a.message:"删除失败，请稍后重试";d({title:e,icon:"none"})}}})}return o(z,(e=>{e&&!D.value&&(G.softwareId=e.softwareId,G.displayName=e.displayName,G.apiAddress=e.apiAddress,G.apiPort=e.apiPort,G.softwareType=e.softwareType)}),{immediate:!0}),n((async()=>{if(V.isAuthorAuthenticated){if(!$.value)try{await V.fetchAuthorProfile()}catch(e){d({title:"加载作者信息失败",icon:"none"})}await async function(){E.value&&V.isAuthorAuthenticated&&(await V.fetchWeChatBinding("author").catch((()=>{})),V.fetchWeChatTemplates().catch((()=>{})))}()}else u({url:"/pages/login/author"})})),(e,a)=>{const t=b,l=I,s=C,o=P,i=N,n=S;return $.value?(r(),c(s,{key:0,class:"page"},{default:f((()=>[p(s,{class:"top-bar"},{default:f((()=>[p(t,{class:"page-title"},{default:f((()=>[v("软件管理")])),_:1}),p(s,{class:"top-actions"},{default:f((()=>[p(l,{class:"ghost",onClick:se},{default:f((()=>[v("退出登录")])),_:1}),p(l,{class:"danger",disabled:m(V).loading.deleteAuthor,onClick:oe},{default:f((()=>[v(h(m(V).loading.deleteAuthor?"注销中...":"注销账号"),1)])),_:1},8,["disabled"])])),_:1})])),_:1}),p(n,{"scroll-y":"",class:"content"},{default:f((()=>[p(s,{class:"glass-card section"},{default:f((()=>[p(s,{class:"section-header"},{default:f((()=>[p(t,{class:"section-title"},{default:f((()=>[v("选择软件")])),_:1}),p(l,{class:"link ghost",onClick:ee,disabled:m(V).loading.createAuthorSoftware},{default:f((()=>[v(h(m(V).loading.createAuthorSoftware?"处理中...":"新增软件码"),1)])),_:1},8,["disabled"])])),_:1}),j.value.length?(r(),w(y,{key:0},[j.value.length>1?(r(),c(s,{key:0,class:"selector"},{default:f((()=>[p(o,{range:j.value,"range-key":"displayName",onChange:R},{default:f((()=>[p(s,{class:"picker"},{default:f((()=>{var e;return[v(h((null==(e=z.value)?void 0:e.displayName)||"选择软件"),1)]})),_:1})])),_:1},8,["range"])])),_:1})):g("",!0)],64)):(r(),c(s,{key:1,class:"empty-tip"},{default:f((()=>[v("暂无软件，请先新增。")])),_:1})),j.value.length?(r(),c(s,{key:2,class:"software-list"},{default:f((()=>[(r(!0),w(y,null,_(j.value,(e=>{var a;return r(),c(s,{key:e.softwareId,class:T(["software-card",(null==(a=z.value)?void 0:a.softwareId)===e.softwareId?"active":""])},{default:f((()=>[p(s,{class:"software-header"},{default:f((()=>[p(t,{class:"software-name"},{default:f((()=>[v(h(e.displayName),1)])),_:2},1024),p(t,{class:"software-tag"},{default:f((()=>[v(h(Z(e.softwareType)),1)])),_:2},1024)])),_:2},1024),p(s,{class:"software-code-row"},{default:f((()=>[p(t,{class:"software-code"},{default:f((()=>[v("软件码："+h(e.softwareCode),1)])),_:2},1024),p(l,{class:"ghost mini",onClick:a=>X(e.softwareCode)},{default:f((()=>[v("复制")])),_:2},1032,["onClick"])])),_:2},1024),p(t,{class:"software-endpoint"},{default:f((()=>[v("接口："+h(e.apiAddress)+":"+h(e.apiPort),1)])),_:2},1024),p(s,{class:"software-actions"},{default:f((()=>{var a;return[p(l,{class:"ghost small",disabled:(null==(a=z.value)?void 0:a.softwareId)===e.softwareId,onClick:a=>Y(e)},{default:f((()=>{var a;return[v(h((null==(a=z.value)?void 0:a.softwareId)===e.softwareId?"当前使用":"设为当前"),1)]})),_:2},1032,["disabled","onClick"]),p(l,{class:"ghost small",onClick:a=>function(e){Y(e),G.softwareId=e.softwareId,G.displayName=e.displayName,G.apiAddress=e.apiAddress,G.apiPort=e.apiPort,G.softwareType=e.softwareType,D.value=!1}(e)},{default:f((()=>[v("编辑")])),_:2},1032,["onClick"])]})),_:2},1024)])),_:2},1032,["class"])})),128))])),_:1})):g("",!0),z.value?(r(),c(s,{key:3,class:"info"},{default:f((()=>[p(s,{class:"info-item code-line"},{default:f((()=>[p(t,null,{default:f((()=>[v("当前软件码："+h(z.value.softwareCode),1)])),_:1}),p(l,{class:"ghost mini",onClick:a[0]||(a[0]=e=>X(z.value.softwareCode))},{default:f((()=>[v("复制")])),_:1})])),_:1}),p(s,{class:"info-actions"},{default:f((()=>[p(l,{class:"link",onClick:le,disabled:m(V).loading.regenerateAuthorCode},{default:f((()=>[v(h(m(V).loading.regenerateAuthorCode?"生成中...":"刷新软件码"),1)])),_:1},8,["disabled"]),p(l,{class:"link danger",onClick:ie,disabled:m(V).loading.deleteAuthorSoftware||j.value.length<=1},{default:f((()=>[v(" 删除软件码 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):g("",!0)])),_:1}),D.value||z.value?(r(),c(s,{key:0,class:"glass-card section"},{default:f((()=>[p(s,{class:"section-header"},{default:f((()=>[p(t,{class:"section-title"},{default:f((()=>[v(h(D.value?"新增软件配置":"更新接口配置"),1)])),_:1})])),_:1}),p(s,{class:"form"},{default:f((()=>[p(s,{class:"form-item"},{default:f((()=>[p(t,{class:"label"},{default:f((()=>[v("展示名称")])),_:1}),p(i,{modelValue:G.displayName,"onUpdate:modelValue":a[1]||(a[1]=e=>G.displayName=e),class:"input",placeholder:"作者昵称或公司名"},null,8,["modelValue"])])),_:1}),p(s,{class:"form-item"},{default:f((()=>[p(t,{class:"label"},{default:f((()=>[v("接口地址")])),_:1}),p(i,{modelValue:G.apiAddress,"onUpdate:modelValue":a[2]||(a[2]=e=>G.apiAddress=e),class:"input",placeholder:"部署主机 IP 或域名"},null,8,["modelValue"])])),_:1}),p(s,{class:"form-item"},{default:f((()=>[p(t,{class:"label"},{default:f((()=>[v("接口端口")])),_:1}),p(i,{modelValue:G.apiPort,"onUpdate:modelValue":a[3]||(a[3]=e=>G.apiPort=e),modelModifiers:{number:!0},class:"input",type:"number",placeholder:"如：8080"},null,8,["modelValue"])])),_:1}),p(s,{class:"form-item"},{default:f((()=>[p(t,{class:"label"},{default:f((()=>[v("软件类型")])),_:1}),p(o,{range:H,"range-key":"label",onChange:L},{default:f((()=>[p(s,{class:"picker"},{default:f((()=>[v(h(J.value.label),1)])),_:1})])),_:1})])),_:1})])),_:1}),p(s,{class:"form-actions"},{default:f((()=>[p(l,{class:"submit",disabled:K.value,onClick:te},{default:f((()=>[v(h(K.value?"保存中...":D.value?"提交新增":"保存修改"),1)])),_:1},8,["disabled"]),D.value?(r(),c(l,{key:0,class:"ghost",onClick:ae},{default:f((()=>[v("取消")])),_:1})):g("",!0)])),_:1})])),_:1})):g("",!0),!D.value&&z.value?(r(),c(s,{key:1,class:"glass-card note-card"},{default:f((()=>[p(t,{class:"note-title"},{default:f((()=>[v("提示")])),_:1}),p(t,{class:"note-text"},{default:f((()=>[v("更新后请提醒代理同步新的接口账号密码信息。")])),_:1})])),_:1})):g("",!0)])),_:1})])),_:1})):(r(),c(s,{key:1,class:"empty"},{default:f((()=>[p(t,null,{default:f((()=>[v("正在加载作者信息...")])),_:1})])),_:1}))}}}),[["__scopeId","data-v-53b21c28"]]);export{B as default};

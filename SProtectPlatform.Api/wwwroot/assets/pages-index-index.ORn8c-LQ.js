import{d as e,r as a,G as l,g as t,h as s,z as n,H as u,y as i,o,c as d,w as c,a as r,b as v,t as f,k as m,J as h,E as p,K as g,L as b,i as y,e as _,M as x,N as k,O as T,_ as w,l as M,B as S,F as $,j as C,D as L,x as P,u as N,m as D,p as F,n as B,A as I,s as A,v as R,f as E,P as W,Q as Y,C as V}from"./index-ClZek067.js";import{S as U}from"./SoftwarePicker.DETIBe4X.js";import{D as X}from"./DateTimePicker.BuTZddyf.js";const q=w(e({__name:"TrendChart",props:{title:{},subtitle:{default:""},points:{},total:{default:void 0},totalLabel:{default:void 0},maxValue:{default:void 0}},setup(e){var w;const M=e,S=`trend-${Math.random().toString(36).slice(2)}`,$=a(640),C=a(320),L=a(640),P=a(320),N=a(1);let D=!0;D=!1,"undefined"!=typeof wx&&(D=!1);const F=null==(w=l)?void 0:w();if(F){const e=`${F.uniPlatform||""}`.toLowerCase(),a=`${F.appName||""}`.toLowerCase();(e.includes("mp")||e.includes("wechat")||a.includes("wechat"))&&(D=!1)}let B=1;const I=a(!1),A=k(),R=a(null),E=a([]),W=t({visible:!1,x:0,y:0,label:"",value:0}),Y=s((()=>({left:`${W.x}px`,top:`${W.y}px`}))),V=s((()=>{if(null==M.total)return"";return`${M.totalLabel||"累计总计"}：${M.total}`}));function U(){I.value&&function(e){if(!e.length)return;const a=T(S,null==A?void 0:A.proxy),l=N.value||1;"function"==typeof a.scale&&Math.abs(B-1)>.001&&(a.scale(1/B,1/B),B=1),a.clearRect(0,0,$.value,C.value),1!==l&&"function"==typeof a.scale?(a.scale(l,l),B=l):B=1;const t=L.value||$.value/l,s=P.value||C.value/l,n=60,i=50,o=e=>1!==l?e/l:e,d=e.map((e=>Number(e.value??0))),c=Math.min(...d),r=Math.max(...d),v="number"==typeof M.maxValue&&M.maxValue>0?M.maxValue:r,f=Math.max(v,r),m=Math.min(c,0),h=f-m,p=0===h?1:h,g=Math.max(e.length-1,1),b=e.map(((e,a)=>({x:n+a/g*(t-120),y:s-i-(e.value-m)/p*(s-100),value:Number(e.value??0),label:e.date})));a.setStrokeStyle("rgba(148, 163, 184, 0.18)"),a.setLineWidth(o(1));for(let u=0;u<=4;u+=1){const e=i+(s-100)/4*u;a.beginPath(),a.moveTo(n,e),a.lineTo(t-n,e),a.stroke()}a.setStrokeStyle("rgba(148, 163, 184, 0.28)"),a.setLineWidth(o(1.5)),a.beginPath(),a.moveTo(n,i),a.lineTo(n,s-i),a.lineTo(t-n,s-i),a.stroke(),a.setFillStyle("rgba(226, 232, 240, 0.8)"),a.setFontSize(o(16));for(let u=0;u<=4;u+=1){const e=Math.round(f/4*(4-u)),l=i+(s-100)/4*u;a.fillText(`${e}`,16,l+6)}a.beginPath();const y=a.createLinearGradient(0,0,t,0);y.addColorStop(0,"#38bdf8"),y.addColorStop(1,"#6366f1"),a.setLineWidth(o(3)),a.setStrokeStyle(y),a.setLineJoin("round"),a.setLineCap("round"),b.forEach(((e,l)=>{0===l?a.moveTo(e.x,e.y):a.lineTo(e.x,e.y)})),a.stroke();const _=a.createLinearGradient(0,i,0,s-i);_.addColorStop(0,"rgba(56, 189, 248, 0.32)"),_.addColorStop(1,"rgba(15, 23, 42, 0.05)"),a.setFillStyle(_),a.beginPath(),b.forEach(((e,l)=>{0===l?a.moveTo(e.x,e.y):a.lineTo(e.x,e.y)})),a.lineTo(t-n,s-i),a.lineTo(n,s-i),a.closePath(),a.fill(),a.setFillStyle("rgba(226, 232, 240, 0.65)"),a.setFontSize(o(18)),b.forEach(((l,t)=>{if(t%2==0||t===e.length-1){const n=s-i+24;a.fillText(e[t].date,l.x-24,n)}})),b.forEach((e=>{a.beginPath(),a.setFillStyle("#38bdf8"),a.arc(e.x,e.y,o(4),0,2*Math.PI),a.fill()})),a.draw(),E.value=b,u((()=>{X()}))}(M.points)}function X(){b().in(null==A?void 0:A.proxy).select(`#${S}`).boundingClientRect((e=>{var a;if(e){const t=null==(a=l)?void 0:a();let s=1;t&&"number"==typeof t.pixelRatio&&(s=D?Math.max(t.pixelRatio,1):1);const n=Math.max(e.width,1),i=Math.max(e.height,1),o=n*s,d=i*s;R.value={width:n,height:i,left:e.left,top:e.top};let c=!1;Math.abs($.value-o)>1&&($.value=o,c=!0),Math.abs(C.value-d)>1&&(C.value=d,c=!0),(Math.abs(L.value-n)>.5||Math.abs(P.value-i)>.5)&&(L.value=n,P.value=i,c=!0),Math.abs(N.value-s)>.01&&(N.value=s,c=!0),c&&u((()=>{U()}))}})).exec()}function q(e){const a=function(e){if((null==e?void 0:e.detail)&&"number"==typeof e.detail.x)return{x:e.detail.x,y:e.detail.y};if((null==e?void 0:e.changedTouches)&&e.changedTouches.length){const a=e.changedTouches[0];if("number"==typeof a.x&&"number"==typeof a.y)return{x:a.x,y:a.y};if(R.value&&"number"==typeof a.pageX&&"number"==typeof a.pageY)return{x:a.pageX-R.value.left,y:a.pageY-R.value.top}}return"number"==typeof(null==e?void 0:e.offsetX)&&"number"==typeof(null==e?void 0:e.offsetY)?{x:e.offsetX,y:e.offsetY}:null}(e);if(!a)return;let l=R.value;l||(X(),l=R.value);const t=N.value||1,s=L.value||$.value/t,n=P.value||C.value/t,u=l&&l.width?s/l.width:1,i=function(e){if(!E.value.length)return null;let a=E.value[0],l=Math.abs(a.x-e);return E.value.forEach((t=>{const s=Math.abs(t.x-e);s<l&&(a=t,l=s)})),l<=40?a:null}(a.x*u);if(!i)return void(W.visible=!1);const o=(null==l?void 0:l.width)??s,d=(null==l?void 0:l.height)??n;W.visible=!0,W.label=i.label,W.value=`数量：${i.value}`,W.x=i.x/s*o,W.y=i.y/n*d}function j(){W.visible=!1}return n((async()=>{await u(),I.value=!0,U(),X()})),i((()=>M.points),(e=>{e.length&&u((()=>{U(),X()}))}),{deep:!0}),(e,a)=>{const l=y,t=_,s=x;return o(),d(t,{class:"chart-card glass-card"},{default:c((()=>[r(t,{class:"chart-header"},{default:c((()=>[r(t,null,{default:c((()=>[r(l,{class:"chart-title"},{default:c((()=>[v(f(e.title),1)])),_:1}),e.subtitle?(o(),d(l,{key:0,class:"chart-subtitle"},{default:c((()=>[v(f(e.subtitle),1)])),_:1})):m("",!0)])),_:1}),r(t,{class:"chart-extra"},{default:c((()=>[h(e.$slots,"extra",{},void 0,!0),V.value?(o(),d(l,{key:0,class:"chart-summary"},{default:c((()=>[v(f(V.value),1)])),_:1})):m("",!0)])),_:3})])),_:3}),r(t,{class:"chart-body"},{default:c((()=>[r(s,{"canvas-id":S,id:S,class:"chart-canvas",width:$.value,height:C.value,onTouchstart:p(q,["stop"]),onTouchmove:p(q,["stop"]),onTouchend:j,onTouchcancel:j,onMousemove:q,onMouseleave:j},null,8,["width","height"]),W.visible?(o(),d(t,{key:0,class:"chart-tooltip",style:g(Y.value)},{default:c((()=>[r(l,{class:"tooltip-title"},{default:c((()=>[v(f(W.label),1)])),_:1}),r(l,{class:"tooltip-value"},{default:c((()=>[v(f(W.value),1)])),_:1})])),_:1},8,["style"])):m("",!0)])),_:1})])),_:3})}}}),[["__scopeId","data-v-52723683"]]),j=w(e({__name:"SubTrendChart",props:{title:{},subtitle:{default:""},categories:{default:()=>[]},series:{default:()=>[]},total:{default:void 0}},setup(e){var h;const w=e,C=`sub-trend-${Math.random().toString(36).slice(2)}`,L=a(640),P=a(360),N=a(640),D=a(360),F=a(1);let B=!0;B=!1,"undefined"!=typeof wx&&(B=!1);const I=null==(h=l)?void 0:h();if(I){const e=`${I.uniPlatform||""}`.toLowerCase(),a=`${I.appName||""}`.toLowerCase();(e.includes("mp")||e.includes("wechat")||a.includes("wechat"))&&(B=!1)}let A=1;const R=["#38bdf8","#8b5cf6","#f97316","#22d3ee","#f472b6","#34d399","#a855f7"],E=k(),W=a(!1),Y=a(null),V=a([]),U=t({visible:!1,x:0,y:0,category:"",items:[]}),X=s((()=>({left:`${U.x}px`,top:`${U.y}px`}))),q=s((()=>w.series)),j=s((()=>null==w.total?"":`最近子代理7天合计：${w.total}`));function z(){if(!W.value)return;const e=T(C,null==E?void 0:E.proxy),a=F.value||1;"function"==typeof e.scale&&Math.abs(A-1)>.001&&(e.scale(1/A,1/A),A=1),e.clearRect(0,0,L.value,P.value),1!==a&&"function"==typeof e.scale?(e.scale(a,a),A=a):A=1;const l=N.value||L.value/a,t=D.value||P.value/a,s=Array.isArray(w.categories)?w.categories:[],n=q.value;if(!s.length||!n.length)return e.draw(),V.value=[],void(U.visible=!1);const i=Math.max(...n.map((e=>{var a;const l=(null==(a=e.values)?void 0:a.length)?e.values.map((e=>Number(e??0))):[0];return Math.max(...l)})),0),o=i>0?Math.ceil(1.1*i):1,d=o||1,c=e=>1!==a?e/a:e;e.setStrokeStyle("rgba(148, 163, 184, 0.18)"),e.setLineWidth(c(1));for(let u=0;u<=4;u+=1){const a=60+(t-120)/4*u;e.beginPath(),e.moveTo(60,a),e.lineTo(l-60,a),e.stroke()}e.setStrokeStyle("rgba(148, 163, 184, 0.3)"),e.setLineWidth(c(1.5)),e.beginPath(),e.moveTo(60,60),e.lineTo(60,t-60),e.lineTo(l-60,t-60),e.stroke(),e.setFillStyle("rgba(226, 232, 240, 0.85)"),e.setFontSize(c(16));for(let u=0;u<=4;u+=1){const a=Math.round(o/4*(4-u)),l=60+(t-120)/4*u;e.fillText(`${a}`,18,l+6)}const r=s.length>1?(l-120)/(s.length-1):0,v=s.map(((e,a)=>{const l=n.map(((e,l)=>{var s;const n=Number((null==(s=e.values)?void 0:s[a])??0),u=Number.isFinite(n)?n:0,i=t-60-u/d*(t-120);return{name:e.name,value:u,color:R[l%R.length],y:i}})),s=l.length?Math.min(...l.map((e=>e.y))):t-60;return{x:60+r*a,label:e,anchorY:s,items:l}}));n.forEach(((a,l)=>{const s=R[l%R.length];e.setStrokeStyle(s),e.setLineWidth(c(2.5)),e.setLineJoin("round"),e.setLineCap("round"),e.beginPath(),v.forEach(((a,s)=>{const n=a.items[l],u=n?n.y:t-60;0===s?e.moveTo(a.x,u):e.lineTo(a.x,u)})),e.stroke(),v.forEach((a=>{const t=a.items[l];t&&(e.beginPath(),e.setFillStyle(s),e.arc(a.x,t.y,c(3.5),0,2*Math.PI),e.fill())}))})),e.setFillStyle("rgba(226, 232, 240, 0.78)"),e.setFontSize(c(18)),v.forEach(((a,l)=>{if(l%2==0||l===v.length-1){const l=t-60+26;e.fillText(a.label,a.x-24,l)}})),e.draw(),V.value=v,u((()=>{O()}))}function O(){b().in(null==E?void 0:E.proxy).select(`#${C}`).boundingClientRect((e=>{var a;if(e){const t=null==(a=l)?void 0:a();let s=1;t&&"number"==typeof t.pixelRatio&&(s=B?Math.max(t.pixelRatio,1):1);const n=Math.max(e.width,1),i=Math.max(e.height,1),o=n*s,d=i*s;Y.value={width:n,height:i,left:e.left,top:e.top};let c=!1;Math.abs(L.value-o)>1&&(L.value=o,c=!0),Math.abs(P.value-d)>1&&(P.value=d,c=!0),(Math.abs(N.value-n)>.5||Math.abs(D.value-i)>.5)&&(N.value=n,D.value=i,c=!0),Math.abs(F.value-s)>.01&&(F.value=s,c=!0),c&&u((()=>{z()}))}})).exec()}function H(e){const a=function(e){if((null==e?void 0:e.detail)&&"number"==typeof e.detail.x)return{x:e.detail.x,y:e.detail.y};if((null==e?void 0:e.changedTouches)&&e.changedTouches.length){const a=e.changedTouches[0];if("number"==typeof a.x&&"number"==typeof a.y)return{x:a.x,y:a.y};if(Y.value&&"number"==typeof a.pageX&&"number"==typeof a.pageY)return{x:a.pageX-Y.value.left,y:a.pageY-Y.value.top}}return"number"==typeof(null==e?void 0:e.offsetX)&&"number"==typeof(null==e?void 0:e.offsetY)?{x:e.offsetX,y:e.offsetY}:null}(e);if(!a)return;let l=Y.value;l||(O(),l=Y.value);const t=F.value||1,s=N.value||L.value/t,n=D.value||P.value/t,u=l&&l.width?s/l.width:1,i=function(e){if(!V.value.length)return null;let a=V.value[0],l=Math.abs(a.x-e);V.value.forEach((t=>{const s=Math.abs(t.x-e);s<l&&(a=t,l=s)}));const t=V.value.length>1?Math.max(Math.abs(V.value[1].x-V.value[0].x)/2,40):60;return l<=t?a:null}(a.x*u);if(!i)return void(U.visible=!1);const o=(null==l?void 0:l.width)??s,d=(null==l?void 0:l.height)??n;U.visible=!0,U.category=i.label,U.items=i.items.slice().sort(((e,a)=>a.value-e.value)).map((e=>({name:e.name,value:`数量：${e.value}`,color:e.color}))),U.x=i.x/s*o,U.y=i.anchorY/n*d}function G(){U.visible=!1}return n((async()=>{await u(),W.value=!0,z(),O()})),i((()=>[w.categories,q.value]),(()=>{u((()=>{z(),O()}))}),{deep:!0}),(e,a)=>{const l=y,t=_,s=x;return o(),d(t,{class:"chart-card glass-card"},{default:c((()=>[r(t,{class:"chart-header"},{default:c((()=>[r(t,null,{default:c((()=>[r(l,{class:"chart-title"},{default:c((()=>[v(f(e.title),1)])),_:1}),e.subtitle?(o(),d(l,{key:0,class:"chart-subtitle"},{default:c((()=>[v(f(e.subtitle),1)])),_:1})):m("",!0)])),_:1}),j.value?(o(),d(l,{key:0,class:"chart-summary"},{default:c((()=>[v(f(j.value),1)])),_:1})):m("",!0)])),_:1}),r(t,{class:"chart-body"},{default:c((()=>[r(s,{"canvas-id":C,id:C,class:"chart-canvas",width:L.value,height:P.value,onTouchstart:p(H,["stop"]),onTouchmove:p(H,["stop"]),onTouchend:G,onTouchcancel:G,onMousemove:H,onMouseleave:G},null,8,["width","height"]),U.visible?(o(),d(t,{key:0,class:"chart-tooltip",style:g(X.value)},{default:c((()=>[r(l,{class:"tooltip-title"},{default:c((()=>[v(f(U.category),1)])),_:1}),r(t,{class:"tooltip-list"},{default:c((()=>[(o(!0),M($,null,S(U.items,(e=>(o(),d(t,{key:e.name,class:"tooltip-row"},{default:c((()=>[r(t,{class:"tooltip-dot",style:g({background:e.color})},null,8,["style"]),r(l,{class:"tooltip-name"},{default:c((()=>[v(f(e.name),1)])),_:2},1024),r(l,{class:"tooltip-value"},{default:c((()=>[v(f(e.value),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1},8,["style"])):m("",!0)])),_:1}),q.value.length?(o(),d(t,{key:0,class:"legend"},{default:c((()=>[(o(!0),M($,null,S(q.value,((e,a)=>(o(),d(t,{key:e.name,class:"legend-item"},{default:c((()=>[r(t,{class:"legend-dot",style:g({background:R[a%R.length]})},null,8,["style"]),r(l,{class:"legend-name"},{default:c((()=>[v(f(e.name),1)])),_:2},1024),r(l,{class:"legend-value"},{default:c((()=>[v(f(e.total),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(o(),d(t,{key:1,class:"empty"},{default:c((()=>[v("暂无子代理激活记录")])),_:1}))])),_:1})}}}),[["__scopeId","data-v-4edebaf9"]]),z=w(e({__name:"StatCard",props:{title:{},value:{},delta:{},trend:{}},setup(e){const a=e,l=s((()=>"up"===a.trend?"delta-up":"down"===a.trend?"delta-down":"delta-flat")),t=s((()=>`${Math.abs(a.delta)}%`));return(e,a)=>{const s=_,n=y;return o(),d(s,{class:"stat-card glass-card"},{default:c((()=>[r(s,{class:"stat-title"},{default:c((()=>[v(f(e.title),1)])),_:1}),r(s,{class:"stat-value"},{default:c((()=>[v(f(e.value),1)])),_:1}),r(s,{class:"stat-footer"},{default:c((()=>[r(s,{class:C(["delta",l.value])},{default:c((()=>["up"===e.trend?(o(),d(n,{key:0},{default:c((()=>[v("▲")])),_:1})):"down"===e.trend?(o(),d(n,{key:1},{default:c((()=>[v("▼")])),_:1})):(o(),d(n,{key:2},{default:c((()=>[v("◼")])),_:1})),r(n,{class:"delta-value"},{default:c((()=>[v(f(t.value),1)])),_:1})])),_:1},8,["class"]),r(n,{class:"delta-label"},{default:c((()=>[v("较昨日")])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-383daff0"]]),O=w(e({__name:"index",setup(e){const l=L(),{dashboard:u,systemStatus:h,profile:p,selectedSoftware:g,cardTypes:b,agents:x,theme:k,chatUnreadCount:T,hasNewBlacklistLogs:w,settlementHasReminder:O}=P(l),H=N(),{agentWeChatBinding:G,agentWechatSubscriptions:J,wechatTemplates:Q,wechatTemplatePreviews:K}=P(H),Z=a(!1),ee=s((()=>Boolean(G.value))),ae=s((()=>H.loading.wechatBinding||H.loading.wechatBind||H.loading.wechatUnbind)),le=s((()=>{var e,a,l,t,s,n;const u=Q.value;if(!u)return[];return[{key:"instant",title:"即时沟通提醒",description:"客户有新留言或待处理消息时提醒",templateId:(null==(e=u.instantCommunication)?void 0:e.trim())??"",preview:(null==(a=K.value)?void 0:a.instant)??null},{key:"blacklist",title:"黑名单严重警告",description:"黑名单记录触发时第一时间通知",templateId:(null==(l=u.blacklistAlert)?void 0:l.trim())??"",preview:(null==(t=K.value)?void 0:t.blacklist)??null},{key:"settlement",title:"结算账单通知",description:"结算周期到期后提醒待对账金额",templateId:(null==(s=u.settlementNotice)?void 0:s.trim())??"",preview:(null==(n=K.value)?void 0:n.settlement)??null}].filter((e=>e.templateId.length>=10&&!e.templateId.includes("...")))})),te=s((()=>J.value??{}));s((()=>ee.value&&le.value.length>0)),s((()=>{var e;const a=G.value;if(!a)return"";const l=null==(e=a.nickname)?void 0:e.trim();return l||((t=a.openId)?t.length<=6?t:`${t.slice(0,4)}***${t.slice(-3)}`:"");var t})),s((()=>ae.value?"处理中...":ee.value?"重新绑定":"绑定微信")),s((()=>Z.value?ae.value&&!G.value?"加载中...":ee.value?"已绑定":"未绑定":"仅微信小程序支持")),a(!1);const se=a(!1),ne=s((()=>H.bindings.map((e=>{var a;const l=null==(a=e.authorDisplayName)?void 0:a.trim();return l||(e.softwareType?`${e.softwareType} (${e.softwareCode})`:e.softwareCode)})))),ue=s((()=>{if(!H.selectedBinding)return 0;const e=H.bindings.findIndex((e=>{var a;return e.bindingId===(null==(a=H.selectedBinding)?void 0:a.bindingId)}));return e>=0?e:0})),ie=s((()=>{if(!H.bindings.length)return"尚未绑定软件码";if(!H.selectedBinding)return ne.value[ue.value]??"请选择软件码";if(!ne.value.length){const e=H.selectedBinding;return e?e.authorDisplayName||e.softwareCode:"请选择软件码"}return ne.value[ue.value]??ne.value[0]})),oe=s((()=>!H.bindings.length||se.value||H.loading.bindings));i((()=>{var e;return[(null==(e=G.value)?void 0:e.openId)??null,le.value.length]}),(()=>{!function(){if(!ee.value||!le.value.length)return;const e=te.value;e&&Object.keys(e).length>0||le.value.forEach((e=>{H.setAgentWechatSubscription(e.key,!0)}))}()}),{immediate:!0});const de=s((()=>u.value.stats??[])),ce=s((()=>de.value.map((e=>({key:e.key,label:e.label,value:e.value,delta:0,trend:"flat"}))))),re=s((()=>u.value.trend??[])),ve=s((()=>u.value.trendTotal??0)),fe=s((()=>Math.max(0,Math.ceil(u.value.trendMax??0)))),me=s((()=>u.value.subAgentTrend??{categories:[],series:[],total:0})),he=s((()=>u.value.announcements??[])),pe=s((()=>u.value.usageHeatmap??[])),ge=s((()=>{var e,a;const l=null==(a=null==(e=p.value)?void 0:e.name)?void 0:a.trim();return l?l.charAt(0).toUpperCase():"访"})),be=s((()=>l.loading.dashboard)),ye=s((()=>l.loading.sales)),_e=s((()=>l.loading.logout)),xe=s((()=>u.value.salesResult??{count:0,cards:[]})),ke=s((()=>xe.value.settlements??[])),Te=s((()=>Number(xe.value.totalAmount??0))),we=a(1),Me=s((()=>{const e=xe.value.cards||[],a=20*(we.value-1);return e.slice(a,a+20)})),Se=s((()=>{var e;const a=(null==(e=xe.value.cards)?void 0:e.length)??0;return Math.max(1,Math.ceil(a/20))})),$e=s((()=>{const e=u.value.salesFilters;if(!e)return"";return`时间：${(e.startTime??"-")||"-"} ~ ${(e.endTime??"-")||"-"}，代理：${(e.agent?e.agent:"全部")||"全部"}`})),Ce=s((()=>["全部",...b.value.map((e=>e.name))])),Le=["全部","启用","禁用"],Pe=s((()=>["全部",...x.value.map((e=>e.username))])),Ne=a(0),De=a(0),Fe=a(0),Be=t({cardType:"",status:"",agent:"",includeDescendants:!0,startTime:"",endTime:""}),Ie=[{label:"暗夜",value:"dark"},{label:"明亮",value:"light"},{label:"卡通",value:"cartoon"}],Ae=Ie.map((e=>e.label)),Re=a(0),Ee=[{label:"软件绑定管理",description:"新增、修改与删除绑定软件码",path:"/pages/agent/bind"},{label:"结算设置",description:"为当前账号维护各卡密类型的结算价格",path:"/pages/agent/settlement"},{label:"卡密管理",description:"搜索、启用禁用与解绑操作",path:"/pages/cards/index"},{label:"代理管理",description:"封禁启用、加款与权限配置",path:"/pages/agents/index"},{label:"即时沟通",description:"与渠道实时协同巡检",path:"/pages/chat/index"},{label:"卡密验证",description:"批量验证与下载链接",path:"/pages/verify/index"},{label:"黑名单记录",description:"查询黑名单触发日志",path:"/pages/blacklist/logs/index"},{label:"黑名单机器码",description:"管理封禁机器码",path:"/pages/blacklist/machines/index"}],We=s((()=>{const e=T.value,a=w.value;return Ee.map((l=>{const t={...l};return"/pages/chat/index"===l.path&&e>0?t.badge={type:"info",label:"新消息",value:e>99?"99+":String(e)}:"/pages/agent/settlement"===l.path&&O.value?t.badge={type:"alert",label:"待结算",subtext:"请尽快处理"}:"/pages/blacklist/logs/index"===l.path&&a&&(t.badge={type:"alert",label:"严重警告",subtext:"有人尝试破解"}),t}))})),Ye=s((()=>{const e=h.value;return e?{machine:e.machineName||"未识别主机",os:e.osDescription||"未知系统",cpu:null!=e.cpuLoadPercentage?`${e.cpuLoadPercentage.toFixed(1)}%`:"--",memory:null!=e.memoryUsagePercentage?`${e.memoryUsagePercentage.toFixed(1)}%`:"--",uptime:ta(e.uptimeSeconds),boot:e.bootTime?Y(e.bootTime):"--",warnings:Array.isArray(e.warnings)?e.warnings:[]}:null}));function Ve(e){const a=e=>e.toString().padStart(2,"0");return`${e.getFullYear()}-${a(e.getMonth()+1)}-${a(e.getDate())} ${a(e.getHours())}:${a(e.getMinutes())}`}function Ue(e){if(!e)return"";const a=e.trim();if(!a)return"";if(/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}$/.test(a))return a;const l=new Date(a.replace("T"," ").replace(/\//g,"-"));return Number.isNaN(l.getTime())?"":Ve(l)}function Xe(e){return Ue(e)}function qe(e){const a=Number(e??0);return Number.isFinite(a)?a.toFixed(2):"0.00"}function je(e){const a=new Date,l=new Date(a.getTime()-5184e5);Be.cardType=(null==e?void 0:e.cardType)??"",Be.status=(null==e?void 0:e.status)??"",Be.agent=(null==e?void 0:e.agent)??"",Be.includeDescendants=(null==e?void 0:e.includeDescendants)??!0,Be.startTime=Ue(null==e?void 0:e.startTime)||Ve(l),Be.endTime=Ue(null==e?void 0:e.endTime)||Ve(a),Ne.value=Math.max(0,Ce.value.indexOf(Be.cardType||"全部")),De.value=Math.max(0,Le.indexOf(Be.status||"全部")),Fe.value=Math.max(0,Pe.value.indexOf(Be.agent||"全部")),we.value=1}function ze(e){const a=(e??"").toString().trim();a?V({data:a,success:()=>{A({title:"已复制",icon:"success",duration:800})},fail:()=>{A({title:"复制失败",icon:"none"})}}):A({title:"无可复制内容",icon:"none"})}function Oe(e){e<1||e>Se.value||e===we.value||(we.value=e)}function He(e){const a=Number(e.detail.value),t=Ie[a]??Ie[0];Re.value=a,l.setTheme(t.value)}async function Ge(){if(!_e.value)try{await l.logout()}catch(e){console.error("退出登录失败",e),A({title:"退出失败，请重试",icon:"none"})}}function Je(){je({includeDescendants:!0}),l.clearSalesResult({includeDescendants:Be.includeDescendants,cardType:"",status:"",agent:"",startTime:Be.startTime,endTime:Be.endTime})}async function Qe(){if(g.value)try{const e=Xe(Be.startTime),a=Xe(Be.endTime);await l.runSalesQuery({cardType:Be.cardType||void 0,status:Be.status||void 0,agent:Be.agent||void 0,includeDescendants:Be.includeDescendants,startTime:e||void 0,endTime:a||void 0}),A({title:"查询完成",icon:"success"})}catch(e){console.error("submitSalesQuery error",e),A({title:"查询失败",icon:"none"})}else A({title:"请先选择软件位",icon:"none"})}function Ke(e){const a=Number(e.detail.value);Ne.value=a,Be.cardType=0===a?"":Ce.value[a]}function Ze(e){const a=Number(e.detail.value);De.value=a,Be.status=0===a?"":Le[a]}function ea(e){const a=Number(e.detail.value);Fe.value=a,Be.agent=0===a?"":Pe.value[a]}async function aa(e,a){if(e.authorAccount&&e.authorPassword){se.value=!0;try{await l.login({username:e.authorAccount,password:e.authorPassword},{skipBootstrap:!1})}catch(t){if(!(null==a?void 0:a.silent)){const e=(null==t?void 0:t.message)&&"string"==typeof t.message?t.message:"同步作者登录失败";A({title:e,icon:"none"})}throw t}finally{se.value=!1}}}function la(e){var a;const l=Number(e.detail.value??ue.value),t=H.bindings[l];t&&(null==(a=H.selectedBinding)?void 0:a.bindingId)!==t.bindingId&&(H.selectBinding(t),aa(t,{silent:!0}).then((()=>{A({title:`已切换 ${t.softwareCode}`,icon:"success"})})).catch((()=>{})))}function ta(e){if(null==e)return"—";const a=Number(e);if(!Number.isFinite(a)||a<=0)return"—";const l=Math.floor(a/86400),t=Math.floor(a%86400/3600),s=Math.floor(a%3600/60);if(l>0)return`${l}天${t}小时`;if(t>0)return`${t}小时${s}分钟`;return`${s}分钟${Math.floor(a%60)}秒`}return n((async()=>{if(H.isAuthenticated)if(await async function(){Z.value&&H.isAuthenticated&&await H.fetchWeChatBinding("agent").catch((()=>{}))}(),Z.value&&H.fetchWeChatTemplates().catch((()=>{})),H.bindings.length||await H.fetchAgentProfile(),!H.selectedBinding&&H.bindings.length&&H.selectBinding(H.bindings[0]),H.selectedBinding){try{await aa(H.selectedBinding,{silent:!0})}catch(e){console.warn("自动同步作者凭证失败",e)}await l.ensureReady(),await l.loadDashboard(),await Promise.all([l.loadCardTypes(),l.loadAgents({limit:200}),l.loadChatSessions().catch((e=>{console.warn("加载即时沟通会话失败",e)})),l.loadBlacklistLogs(100).catch((e=>{console.warn("加载黑名单日志失败",e)}))]),je(u.value.salesFilters??{includeDescendants:!0})}else F({title:"尚未绑定作者",content:"请先绑定软件码后再访问控制台。",showCancel:!1,success:()=>{B({url:"/pages/agent/bind"})}});else D({url:"/pages/login/agent"})})),i((()=>g.value),((e,a)=>{e&&e!==a&&(l.loadDashboard(),l.loadCardTypes(!0),l.loadAgents({limit:200,page:1,keyword:""}),l.loadChatSessions().catch((e=>{console.warn("切换软件时加载会话失败",e)})),l.loadBlacklistLogs(100).catch((e=>{console.warn("切换软件时加载黑名单日志失败",e)})),Je())})),i((()=>u.value.salesFilters),(e=>{e?je(e):Je()}),{immediate:!0}),i((()=>u.value.salesResult),(()=>{we.value=1})),i(k,(e=>{const a=Ie.findIndex((a=>a.value===e));Re.value=a>=0?a:0}),{immediate:!0}),(e,a)=>{const l=y,t=_,s=R,n=E,u=W;return o(),d(t,{class:"page"},{default:c((()=>[r(t,{class:"hero glass-card"},{default:c((()=>[r(t,{class:"hero-text"},{default:c((()=>[r(l,{class:"hero-badge"},{default:c((()=>[v("SProtect · 代理后台中心")])),_:1}),r(l,{class:"hero-title"},{default:c((()=>[v("代理监控面板")])),_:1}),r(l,{class:"hero-subtitle"},{default:c((()=>[v(" 实时掌握软件激活、代理活跃度与卡密发放情况，支持桌面与移动端自适配。 ")])),_:1})])),_:1}),r(t,{class:"hero-meta"},{default:c((()=>[r(t,{class:"meta-item"},{default:c((()=>[r(l,{class:"meta-label"},{default:c((()=>[v("绑定软件码")])),_:1}),r(s,{mode:"selector",range:ne.value,value:ue.value,disabled:oe.value,onChange:la},{default:c((()=>[r(t,{class:C(["picker-display",oe.value?"picker-disabled":""])},{default:c((()=>[v(f(ie.value),1)])),_:1},8,["class"])])),_:1},8,["range","value","disabled"])])),_:1}),r(t,{class:"meta-item"},{default:c((()=>[r(l,{class:"meta-label"},{default:c((()=>[v("当前软件位")])),_:1}),r(U)])),_:1}),r(t,{class:"meta-item theme-item"},{default:c((()=>[r(l,{class:"meta-label"},{default:c((()=>[v("主题样式")])),_:1}),r(s,{mode:"selector",range:I(Ae),value:Re.value,onChange:He},{default:c((()=>[r(t,{class:"picker-display"},{default:c((()=>[v(f(I(Ae)[Re.value]),1)])),_:1})])),_:1},8,["range","value"])])),_:1}),r(t,{class:"meta-item account-item"},{default:c((()=>[r(l,{class:"meta-label"},{default:c((()=>[v("登录账号")])),_:1}),r(t,{class:"account-info"},{default:c((()=>[r(t,{class:"account-avatar"},{default:c((()=>[v(f(ge.value),1)])),_:1}),r(l,{class:"meta-value"},{default:c((()=>{var e;return[v(f((null==(e=I(p))?void 0:e.name)??"未登录"),1)]})),_:1})])),_:1})])),_:1}),r(t,{class:"meta-item role-item"},{default:c((()=>[r(l,{class:"meta-label"},{default:c((()=>[v("角色权限")])),_:1}),r(t,{class:"role-row"},{default:c((()=>[r(l,{class:"meta-value"},{default:c((()=>{var e;return[v(f((null==(e=I(p))?void 0:e.role)??"访客"),1)]})),_:1}),r(n,{class:"meta-button ghost",disabled:_e.value,onClick:Ge},{default:c((()=>[v(f(_e.value?"正在退出...":"退出登录"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1})])),_:1}),r(t,{class:"quick-nav glass-card"},{default:c((()=>[r(t,{class:"quick-nav-title"},{default:c((()=>[v("快捷导航")])),_:1}),r(t,{class:"quick-nav-grid"},{default:c((()=>[(o(!0),M($,null,S(We.value,(e=>(o(),d(t,{key:e.path,class:"quick-nav-item",onClick:a=>{return l=e.path,void B({url:l});var l}},{default:c((()=>[e.badge?(o(),d(t,{key:0,class:C(["quick-nav-badge",`badge-${e.badge.type}`])},{default:c((()=>[r(t,{class:"badge-main"},{default:c((()=>[r(l,{class:"badge-text"},{default:c((()=>[v(f(e.badge.label),1)])),_:2},1024),e.badge.value?(o(),d(l,{key:0,class:"badge-count"},{default:c((()=>[v(f(e.badge.value),1)])),_:2},1024)):m("",!0)])),_:2},1024),e.badge.subtext?(o(),d(l,{key:0,class:"badge-subtext"},{default:c((()=>[v(f(e.badge.subtext),1)])),_:2},1024)):m("",!0)])),_:2},1032,["class"])):m("",!0),r(t,{class:"quick-nav-item-head"},{default:c((()=>[v(f(e.label),1)])),_:2},1024),r(t,{class:"quick-nav-item-desc"},{default:c((()=>[v(f(e.description),1)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1})])),_:1}),Ye.value?(o(),d(t,{key:0,class:"system glass-card"},{default:c((()=>[r(t,{class:"system-header"},{default:c((()=>[r(l,{class:"system-title"},{default:c((()=>[v("服务器状态")])),_:1}),r(l,{class:"system-subtitle"},{default:c((()=>[v(f(Ye.value.machine)+" · "+f(Ye.value.os),1)])),_:1})])),_:1}),r(t,{class:"system-grid"},{default:c((()=>[r(t,{class:"system-item"},{default:c((()=>[r(l,{class:"system-label"},{default:c((()=>[v("CPU 负载")])),_:1}),r(l,{class:"system-value"},{default:c((()=>[v(f(Ye.value.cpu),1)])),_:1})])),_:1}),r(t,{class:"system-item"},{default:c((()=>[r(l,{class:"system-label"},{default:c((()=>[v("内存占用")])),_:1}),r(l,{class:"system-value"},{default:c((()=>[v(f(Ye.value.memory),1)])),_:1})])),_:1}),r(t,{class:"system-item"},{default:c((()=>[r(l,{class:"system-label"},{default:c((()=>[v("运行时长")])),_:1}),r(l,{class:"system-value"},{default:c((()=>[v(f(Ye.value.uptime),1)])),_:1})])),_:1}),r(t,{class:"system-item"},{default:c((()=>[r(l,{class:"system-label"},{default:c((()=>[v("最近启动")])),_:1}),r(l,{class:"system-value"},{default:c((()=>[v(f(Ye.value.boot),1)])),_:1})])),_:1})])),_:1}),Ye.value.warnings.length?(o(),d(t,{key:0,class:"system-warning"},{default:c((()=>[(o(!0),M($,null,S(Ye.value.warnings,((e,a)=>(o(),d(l,{key:a},{default:c((()=>[v(f(e),1)])),_:2},1024)))),128))])),_:1})):m("",!0)])),_:1})):m("",!0),r(t,{class:"stat-grid"},{default:c((()=>[(o(!0),M($,null,S(ce.value,(e=>(o(),d(z,{key:e.key,title:e.label,value:e.value,delta:e.delta,trend:e.trend},null,8,["title","value","delta","trend"])))),128))])),_:1}),r(q,{title:"过去 7 日总体态势",subtitle:"包含封禁",points:re.value,total:ve.value,"total-label":"最近7天总计","max-value":fe.value},{extra:c((()=>[r(t,{class:"chart-extra"},{default:c((()=>[v("单位：综合评分")])),_:1})])),_:1},8,["points","total","max-value"]),r(j,{title:"最近子代理 7 天激活趋势",subtitle:"洞察各下级代理激活情况",categories:me.value.categories,series:me.value.series,total:me.value.total},null,8,["categories","series","total"]),r(t,{class:"panel glass-card sales-panel"},{default:c((()=>[r(t,{class:"panel-header"},{default:c((()=>[r(l,{class:"panel-title"},{default:c((()=>[v("销量查询")])),_:1}),r(l,{class:"panel-subtitle"},{default:c((()=>[v("按卡种、状态、代理多条件筛选激活记录")])),_:1})])),_:1}),r(t,{class:"sales-form"},{default:c((()=>[r(t,{class:"form-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("卡种")])),_:1}),r(s,{mode:"selector",range:Ce.value,value:Ne.value,onChange:Ke},{default:c((()=>[r(t,{class:"picker-display"},{default:c((()=>[v(f(Ce.value[Ne.value]),1)])),_:1})])),_:1},8,["range","value"])])),_:1}),r(t,{class:"form-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("状态")])),_:1}),r(s,{mode:"selector",range:Le,value:De.value,onChange:Ze},{default:c((()=>[r(t,{class:"picker-display"},{default:c((()=>[v(f(Le[De.value]),1)])),_:1})])),_:1},8,["value"])])),_:1}),r(t,{class:"form-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("代理")])),_:1}),r(s,{mode:"selector",range:Pe.value,value:Fe.value,onChange:ea},{default:c((()=>[r(t,{class:"picker-display"},{default:c((()=>[v(f(Pe.value[Fe.value]),1)])),_:1})])),_:1},8,["range","value"])])),_:1}),r(t,{class:"form-field switch-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("包含下级")])),_:1}),r(u,{checked:Be.includeDescendants,onChange:a[0]||(a[0]=e=>Be.includeDescendants=e.detail.value)},null,8,["checked"])])),_:1}),r(t,{class:"form-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("开始时间")])),_:1}),r(X,{modelValue:Be.startTime,"onUpdate:modelValue":a[1]||(a[1]=e=>Be.startTime=e),placeholder:"选择开始时间"},null,8,["modelValue"])])),_:1}),r(t,{class:"form-field"},{default:c((()=>[r(l,{class:"form-label"},{default:c((()=>[v("结束时间")])),_:1}),r(X,{modelValue:Be.endTime,"onUpdate:modelValue":a[2]||(a[2]=e=>Be.endTime=e),placeholder:"选择结束时间"},null,8,["modelValue"])])),_:1})])),_:1}),r(t,{class:"sales-actions"},{default:c((()=>[r(n,{class:"btn primary",disabled:ye.value,onClick:Qe},{default:c((()=>[v(f(ye.value?"查询中...":"查询"),1)])),_:1},8,["disabled"]),r(n,{class:"btn ghost",disabled:ye.value,onClick:Je},{default:c((()=>[v("重置")])),_:1},8,["disabled"])])),_:1}),ye.value?(o(),d(t,{key:1,class:"panel-empty"},{default:c((()=>[v("查询中...")])),_:1})):(o(),d(t,{key:0,class:"sales-result"},{default:c((()=>[r(t,{class:"sales-summary"},{default:c((()=>[r(l,{class:"sales-count"},{default:c((()=>[v("激活数量："),r(l,{class:"highlight"},{default:c((()=>[v(f(xe.value.count),1)])),_:1})])),_:1}),r(l,{class:"sales-total"},{default:c((()=>[v("结算总额："),r(l,{class:"highlight"},{default:c((()=>[v("￥"+f(qe(Te.value)),1)])),_:1})])),_:1}),r(l,{class:"sales-meta"},{default:c((()=>[v(f($e.value),1)])),_:1})])),_:1}),ke.value.length?(o(),d(t,{key:0,class:"sales-settlement"},{default:c((()=>[r(t,{class:"settlement-header"},{default:c((()=>[r(l,{class:"settlement-col type"},{default:c((()=>[v("卡种")])),_:1}),r(l,{class:"settlement-col count"},{default:c((()=>[v("激活数量")])),_:1}),r(l,{class:"settlement-col price"},{default:c((()=>[v("结算单价")])),_:1}),r(l,{class:"settlement-col total"},{default:c((()=>[v("结算金额")])),_:1})])),_:1}),(o(!0),M($,null,S(ke.value,(e=>(o(),d(t,{key:e.cardType,class:"settlement-row"},{default:c((()=>[r(l,{class:"settlement-col type"},{default:c((()=>[v(f(e.cardType),1)])),_:2},1024),r(l,{class:"settlement-col count"},{default:c((()=>[v(f(e.count),1)])),_:2},1024),r(l,{class:"settlement-col price"},{default:c((()=>[v("￥"+f(qe(e.price)),1)])),_:2},1024),r(l,{class:"settlement-col total"},{default:c((()=>[v("￥"+f(qe(e.total)),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):m("",!0),xe.value.cards.length?(o(),d(t,{key:2,class:"sales-list"},{default:c((()=>[(o(!0),M($,null,S(Me.value,(e=>(o(),d(t,{key:`${e.card}-${e.activateTime}`,class:"sales-entry glass-light"},{default:c((()=>[r(t,{class:"sales-field"},{default:c((()=>[r(l,{class:"sales-label"},{default:c((()=>[v("卡密")])),_:1}),r(l,{class:"sales-value copyable",onLongpress:a=>ze(e.card)},{default:c((()=>[v(f(e.card),1)])),_:2},1032,["onLongpress"])])),_:2},1024),r(t,{class:"sales-field"},{default:c((()=>[r(l,{class:"sales-label"},{default:c((()=>[v("激活时间")])),_:1}),r(l,{class:"sales-value copyable",onLongpress:a=>ze(e.activateTime||"-")},{default:c((()=>[v(f(e.activateTime||"-"),1)])),_:2},1032,["onLongpress"])])),_:2},1024)])),_:2},1024)))),128)),Se.value>1?(o(),d(t,{key:0,class:"sales-pagination"},{default:c((()=>[r(t,{class:"sales-page-info"},{default:c((()=>[v("第 "+f(we.value)+" / "+f(Se.value)+" 页",1)])),_:1}),r(t,{class:"sales-page-actions"},{default:c((()=>[r(n,{class:"page-btn",disabled:we.value<=1||ye.value,onClick:a[3]||(a[3]=e=>Oe(we.value-1))},{default:c((()=>[v(" 上一页 ")])),_:1},8,["disabled"]),r(n,{class:"page-btn",disabled:we.value>=Se.value||ye.value,onClick:a[4]||(a[4]=e=>Oe(we.value+1))},{default:c((()=>[v(" 下一页 ")])),_:1},8,["disabled"])])),_:1})])),_:1})):m("",!0)])),_:1})):(o(),d(t,{key:1,class:"panel-empty"},{default:c((()=>[v("暂无数据")])),_:1}))])),_:1}))])),_:1}),r(t,{class:"layout-grid"},{default:c((()=>[r(t,{class:"panel glass-card"},{default:c((()=>[r(t,{class:"panel-header"},{default:c((()=>[r(l,{class:"panel-title"},{default:c((()=>[v("代理中心公告")])),_:1}),r(l,{class:"panel-subtitle"},{default:c((()=>[v("与渠道共享最新巡检、版本升级信息")])),_:1})])),_:1}),be.value?(o(),d(t,{key:0,class:"panel-empty"},{default:c((()=>[v("公告加载中...")])),_:1})):he.value.length?(o(),d(t,{key:2,class:"announcement-list"},{default:c((()=>[(o(!0),M($,null,S(he.value,(e=>(o(),d(t,{key:e.id,class:"announcement-item"},{default:c((()=>[r(l,{class:"announcement-title"},{default:c((()=>[v(f(e.title),1)])),_:2},1024),r(l,{class:"announcement-content"},{default:c((()=>[v(f(e.content),1)])),_:2},1024),r(t,{class:"announcement-meta"},{default:c((()=>[r(l,null,{default:c((()=>[v(f(e.updatedAt),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(o(),d(t,{key:1,class:"panel-empty"},{default:c((()=>[v("暂无公告")])),_:1}))])),_:1}),r(t,{class:"panel glass-card"},{default:c((()=>[r(t,{class:"panel-header"},{default:c((()=>[r(l,{class:"panel-title"},{default:c((()=>[v("激活地区排行榜")])),_:1}),r(l,{class:"panel-subtitle"},{default:c((()=>[v("核心地区授权分布情况")])),_:1})])),_:1}),be.value?(o(),d(t,{key:0,class:"panel-empty"},{default:c((()=>[v("数据同步中...")])),_:1})):pe.value.length?(o(),d(t,{key:2,class:"heatmap-grid"},{default:c((()=>[(o(!0),M($,null,S(pe.value,(e=>(o(),d(t,{key:e.name,class:"heatmap-item glass-light"},{default:c((()=>[r(l,{class:"heatmap-name"},{default:c((()=>[v(f(e.name),1)])),_:2},1024),r(t,{class:"heatmap-stats"},{default:c((()=>[r(t,null,{default:c((()=>[r(l,{class:"heatmap-label"},{default:c((()=>[v("激活量")])),_:1}),r(l,{class:"heatmap-value"},{default:c((()=>[v(f(e.count),1)])),_:2},1024)])),_:2},1024),r(t,null,{default:c((()=>[r(l,{class:"heatmap-label"},{default:c((()=>[v("占比")])),_:1}),r(l,{class:"heatmap-value"},{default:c((()=>[v(f(e.percentage)+"%",1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1024)))),128))])),_:1})):(o(),d(t,{key:1,class:"panel-empty"},{default:c((()=>[v("暂无节点统计")])),_:1}))])),_:1})])),_:1})])),_:1})}}}),[["__scopeId","data-v-59350055"]]);export{O as default};
